<!DOCTYPE HTML>
<html><head>
<title>Gameboy</title>
<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="default.css">
<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="pygments-default.css">
</head><body>
<h1 id="gameboy-overview">Gameboy Overview</h1>
<p>The Gameboy hardware is made up of several parts:</p>
<ul>
<li>A Z80-like CPU (Sharp LR35902)</li>
<li>A graphics unit capable of hardware background scrolling and sprite blitting</li>
<li>A 160x144 pixel LCD, capable of 3 gray shades</li>
<li>A simple sound generator with 3 channels and stereo output</li>
<li>4-way directional pad, 4 push buttons (A, B, start, select)</li>
</ul>
<p>The emulator is implemented as a library. It does not provide any user
interface, user input, or main loop. This is expected to be implemented in
programs which link against the library. The library is designed with no global
state; this allows multiple Gameboy systems to be emulated in the same process,
and makes the code easier to understand.</p>
<p>To this end a struct is defined which will contain all the state of the emulator:</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="gameboy_state0" href="#gameboy_state0">gameboy state</a> &gt;&gt=
<span class="k">struct</span> <span class="n">Gameboy</span>
<span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
    <span class="kt">uint32_t</span> <span class="p">(</span><span class="o">*</span><span class="n">trace_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gameboy_tp</span><span class="o">*</span> <span class="n">tp</span><span class="p">);</span>
<span class="cp">#endif</span>
    &lt;&lt <a href="#state0">state</a> &gt;&gt;
<span class="p">};</span>
</code></pre>

<div class="toc">
<ul>
<li><a href="#gameboy-overview">Gameboy Overview</a></li>
<li><a href="#the-cpu">The CPU</a></li>
<li><a href="#clocking">Clocking</a><ul>
<li><a href="#divider-and-timer-registers">Divider and Timer Registers</a></li>
</ul>
</li>
<li><a href="#interrupt-handling">Interrupt handling</a></li>
<li><a href="#cpu-emulation">CPU Emulation</a><ul>
<li><a href="#operand-types">Operand Types</a></li>
<li><a href="#load-instructions-ld">Load instructions (ld)</a><ul>
<li><a href="#register-to-register">Register-to-register</a></li>
<li><a href="#memory-to-register-and-register-to-memory">Memory-to-Register and Register-to-Memory</a></li>
<li><a href="#immediate-to-register">Immediate-to-Register</a></li>
</ul>
</li>
<li><a href="#stack-and-stack-pointer">Stack and Stack Pointer</a><ul>
<li><a href="#stack-pushpop">Stack push/pop</a></li>
</ul>
</li>
<li><a href="#8bit-arithmetic">8bit Arithmetic</a></li>
<li><a href="#bitwise-boolean-logic-operations">Bitwise boolean logic operations</a><ul>
<li><a href="#extended-bitwise-operations-0xcb">Extended Bitwise Operations (0xCB)</a></li>
</ul>
</li>
<li><a href="#16-bit-arithemtic">16 bit arithemtic</a></li>
<li><a href="#branchjump-jr-jp">Branch/Jump (jr, jp)</a></li>
<li><a href="#call-and-return-call-ret">Call and Return (call, ret)</a></li>
<li><a href="#misc-instructions">Misc instructions</a><ul>
<li><a href="#interrupt-enabledisable">Interrupt Enable/Disable</a></li>
<li><a href="#halt">Halt</a></li>
<li><a href="#decimal-adjust-accumulator">Decimal Adjust Accumulator</a></li>
<li><a href="#stop">Stop</a></li>
<li><a href="#set-complement-carry-flag">Set &amp; Complement Carry Flag</a></li>
<li><a href="#undocumented">Undocumented</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#core-initialisation-and-main-loop">Core initialisation and main loop</a><ul>
<li><a href="#rom-loading">ROM Loading</a></li>
<li><a href="#resetting">Resetting</a></li>
<li><a href="#main-loop">Main loop</a></li>
</ul>
</li>
<li><a href="#boot-rom">Boot ROM</a></li>
<li><a href="#memory-subsystem-emulation">Memory subsystem emulation</a></li>
<li><a href="#memory-banking"><a name="memory-banking"></a>Memory Banking</a><ul>
<li><a href="#mbc1">MBC1</a></li>
<li><a href="#mbc2">MBC2</a></li>
<li><a href="#mbc3">MBC3</a><ul>
<li><a href="#mbc3-real-time-clock-rtc">MBC3 Real Time Clock (RTC)</a></li>
</ul>
</li>
<li><a href="#mbc5">MBC5</a></li>
</ul>
</li>
<li><a href="#oam-dma-0xff46"><a name="regff46"></a>OAM DMA (0xFF46)</a></li>
<li><a href="#video-emulation">Video emulation</a><ul>
<li><a href="#palettes-0xff47-0xff49">Palettes (0xFF47 - 0xFF49)</a></li>
<li><a href="#video-control-registers">Video control registers</a></li>
<li><a href="#lcd-control-0xff40">LCD Control (0xFF40)</a></li>
<li><a href="#lcd-status-0xff41">LCD Status (0xFF41)</a></li>
<li><a href="#lcd-y-y-compare-0xff44-0xff45">LCD Y &amp; Y Compare (0xFF44 &amp; 0xFF45)</a></li>
<li><a href="#background">Background</a></li>
<li><a href="#window">Window</a></li>
<li><a href="#objects-sprites">Objects (Sprites)</a></li>
<li><a href="#pixel-rendering">Pixel rendering</a></li>
<li><a href="#video-update">Video update</a></li>
</ul>
</li>
<li><a href="#input">Input</a></li>
<li><a href="#io-register-index">IO Register Index</a></li>
<li><a href="#cpu-instruction-index">CPU instruction index</a></li>
<li><a href="#gameboyc">gameboy.c</a></li>
<li><a href="#gameboyh">gameboy.h</a></li>
</ul>
</div>
<h1 id="the-cpu">The CPU</h1>
<p>The CPU has eight 8-bit core registers:</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_registers0" href="#cpu_registers0">cpu registers</a><span class="chunk-index"> (0 <a href="#cpu_registers1">1</a> <a href="#cpu_registers2">2</a> <a href="#cpu_registers3">3</a> <a href="#cpu_registers4">4</a> <a href="#cpu_registers5">5</a> <a href="#cpu_registers6">6</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">H</span><span class="p">,</span> <span class="n">L</span><span class="p">;</span>
</code></pre>

<p><code>A</code> is the accumulator register and many instructions only support operating on
this register. Some instructions use pairs of registers to provide 16-bit
operands; the possible pairs as <code>BC</code>, <code>DE</code>, and <code>HL</code>.</p>
<p>The flags register <code>F</code> stores the additional state about the results of
(primarily) arithmetic operations. It is a bitmask of four values:</p>
<ul>
<li><code>0x80</code> - <code>Z</code> - result was zero</li>
<li><code>0x40</code> - <code>S</code> - instruction is a subtraction</li>
<li><code>0x20</code> - <code>H</code> - a bit was carried between the low and high nibbles (e.g. <code>0x0F + 0x01 = 0x10</code>)</li>
<li><code>0x10</code> - <code>C</code> - a bit was carried out of the low byte of the result (e.g. <code>0xF0 + 0x11 = 0x01</code>)</li>
</ul>
<p>There is a 16-bit stack pointer register used for stack operations. Few
instructions allow direct access to <code>SP</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_registers1" href="#cpu_registers0">cpu registers</a><span class="chunk-index"> (<a href="#cpu_registers0">0</a> 1 <a href="#cpu_registers2">2</a> <a href="#cpu_registers3">3</a> <a href="#cpu_registers4">4</a> <a href="#cpu_registers5">5</a> <a href="#cpu_registers6">6</a>)</span> &gt;&gt=
<span class="kt">uint16_t</span> <span class="n">SP</span><span class="p">;</span>
</code></pre>

<p>The CPU executes instructions from the current address in the program counter,
<code>PC</code>, register. This register is not directly accessable.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_registers2" href="#cpu_registers0">cpu registers</a><span class="chunk-index"> (<a href="#cpu_registers0">0</a> <a href="#cpu_registers1">1</a> 2 <a href="#cpu_registers3">3</a> <a href="#cpu_registers4">4</a> <a href="#cpu_registers5">5</a> <a href="#cpu_registers6">6</a>)</span> &gt;&gt=
<span class="kt">uint16_t</span> <span class="n">PC</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state0" href="#state0">state</a><span class="chunk-index"> (0 <a href="#state1">1</a> <a href="#state2">2</a> <a href="#state3">3</a> <a href="#state4">4</a> <a href="#state5">5</a> <a href="#state6">6</a> <a href="#state7">7</a> <a href="#state8">8</a>)</span> &gt;&gt=
<span class="k">struct</span> <span class="n">GameboyCPU</span> <span class="p">{</span>
    &lt;&lt <a href="#cpu_registers0">cpu registers</a> &gt;&gt;
<span class="p">}</span> <span class="n">cpu</span><span class="p">;</span>
</code></pre>

<h1 id="clocking">Clocking</h1>
<p>The clock runs at ~4.19MHZ, however most operations are measured in machine
cycles, which are 4 clock cycles (~1.05MHz). The shortest CPU operation is 1
machine cycle - this is the length of time to execute a <code>nop</code> instruction or
access a single byte of memory.</p>
<p>Each part of the emulator needs to perform work on every machine cycle.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="clock_functions0" href="#clock_functions0">clock functions</a><span class="chunk-index"> (0 <a href="#clock_functions1">1</a> <a href="#clock_functions2">2</a> <a href="#clock_functions3">3</a> <a href="#clock_functions4">4</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">clock_increment</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    &lt;&lt <a href="#per_machine_cycle_updates0">per machine cycle updates</a> &gt;&gt;
<span class="p">}</span>
</code></pre>

<p>A cycle count is maintained for external use only.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state1" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> 1 <a href="#state2">2</a> <a href="#state3">3</a> <a href="#state4">4</a> <a href="#state5">5</a> <a href="#state6">6</a> <a href="#state7">7</a> <a href="#state8">8</a>)</span> &gt;&gt=
<span class="kt">uint64_t</span> <span class="n">TotalCycles</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset0" href="#reset0">reset</a><span class="chunk-index"> (0 <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">TotalCycles</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="per_machine_cycle_updates0" href="#per_machine_cycle_updates0">per machine cycle updates</a><span class="chunk-index"> (0 <a href="#per_machine_cycle_updates1">1</a> <a href="#per_machine_cycle_updates2">2</a> <a href="#per_machine_cycle_updates3">3</a> <a href="#per_machine_cycle_updates4">4</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">TotalCycles</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
</code></pre>

<h3 id="divider-and-timer-registers">Divider and Timer Registers</h3>
<p>The Gameboy keeps a counter which increments on every clock cycle. This counter
is exposed in two ways: the divider and the timer registers. The divider
register increments at a fixed frequency (1 per 256 clock cycles = 1 per 64
machine cycles). The timer register increments at a configurable frequency and
can provide an interrupt when it overflows.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state2" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> <a href="#state1">1</a> 2 <a href="#state3">3</a> <a href="#state4">4</a> <a href="#state5">5</a> <a href="#state6">6</a> <a href="#state7">7</a> <a href="#state8">8</a>)</span> &gt;&gt=
<span class="k">struct</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">CycleCount</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">TimerOverflow</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">TimerLoading</span><span class="p">;</span>
<span class="p">}</span> <span class="n">clock</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset1" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> 1 <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">CycleCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerOverflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerLoading</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</code></pre>

<p><a name="regff04"></a>The divider and timer actually share a single underlying
16-bit cycle counter which is incremented on each clock cycle. The top 8 bits of
this counter is exposed directly as the divider register at <code>0xFF04</code>. Writing
any value to the divider resets the internal 16-bit counter to zero.</p>
<p><a name="regff05"></a><a name="regff06"></a><a name="regff07"></a>The timer
counter register increments at a rate configured by the timer control register.
When it overflows an interrupt is set and it is reloaded from the timer modulo
register. When to increment the timer counter is determined by a falling edge
detector, the input of which is a bit from the 16-bit cycle counter. The
specific bit is selected depending on the speed selected in bits <code>1:0</code> of the
timer control register.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="clock_functions1" href="#clock_functions0">clock functions</a><span class="chunk-index"> (<a href="#clock_functions0">0</a> 1 <a href="#clock_functions2">2</a> <a href="#clock_functions3">3</a> <a href="#clock_functions4">4</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">bool</span> <span class="nf">clock_getTimerBit</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">control</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cycles</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Timer clock select */</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="cm">/* 4.096 KHz (1024 cycles) */</span>
            <span class="k">return</span> <span class="n">cycles</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="cm">/* 262.144 KHz (16 cycles) */</span>
            <span class="k">return</span> <span class="n">cycles</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="cm">/* 65.536 KHz (64 cycles) */</span>
            <span class="k">return</span> <span class="n">cycles</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="cm">/* 16.384 KHz (256 cycles) */</span>
            <span class="k">return</span> <span class="n">cycles</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>If the timer counter register overflows when it is incremented an interrupt is
set and its value is loaded from the timer modulo register, after a delay of one
machine cycle.  During the delay cycle the timer counter reads zero, but writes
to the counter will cancel the interrupt and the load from the modulo register.
During the machine cycle on which the modulo value is being loaded explicit
writes to the counter register will be ignored, but writes to the modulo
register will be respected (and that value will be loaded into the counter
register).</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="clock_functions2" href="#clock_functions0">clock functions</a><span class="chunk-index"> (<a href="#clock_functions0">0</a> <a href="#clock_functions1">1</a> 2 <a href="#clock_functions3">3</a> <a href="#clock_functions4">4</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clock_timerIncrement</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerCounter</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerOverflow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerCounter</span><span class="p">]</span> <span class="o">=</span> <span class="n">timer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="per_machine_cycle_updates1" href="#per_machine_cycle_updates0">per machine cycle updates</a><span class="chunk-index"> (<a href="#per_machine_cycle_updates0">0</a> 1 <a href="#per_machine_cycle_updates2">2</a> <a href="#per_machine_cycle_updates3">3</a> <a href="#per_machine_cycle_updates4">4</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerLoading</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerOverflow</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Delayed overflow effects */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Interrupt_TIMA</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerOverflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="cm">/* In the next machine cycle the modulo is being loaded */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerCounter</span><span class="p">]</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerModulo</span><span class="p">];</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerLoading</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_write_special_cases0" href="#mmu_write_special_cases0">mmu write special cases</a><span class="chunk-index"> (0 <a href="#mmu_write_special_cases1">1</a> <a href="#mmu_write_special_cases2">2</a> <a href="#mmu_write_special_cases3">3</a> <a href="#mmu_write_special_cases4">4</a> <a href="#mmu_write_special_cases5">5</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">IO_TimerCounter</span><span class="p">:</span>
    <span class="cm">/* Writes to the timer counter whilst it is loading are ignored */</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerLoading</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerCounter</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="cm">/* Writing to timer counter suppresses any pending overflow effects */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerOverflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="nl">IO_TimerModulo</span><span class="p">:</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerModulo</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="cm">/* Whilst the modulo is being loaded any writes are effective immediately */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">TimerLoading</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerCounter</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre>

<p>Changing the speed of the timer or disabling it (by writing to the timer control
register) can change the input to the falling edge detector used to increment
the timer counter. If this produces a falling edge then there will be an "extra"
incremement of the counter.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="clock_functions3" href="#clock_functions0">clock functions</a><span class="chunk-index"> (<a href="#clock_functions0">0</a> <a href="#clock_functions1">1</a> <a href="#clock_functions2">2</a> 3 <a href="#clock_functions4">4</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clock_updateTimerControl</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">old</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerControl</span><span class="p">];</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerControl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

    <span class="cm">/* When disabled the bit to the falling edge detector is zero */</span>
    <span class="kt">bool</span> <span class="k">const</span> <span class="n">oldBit</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">clock_getTimerBit</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">CycleCount</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="k">const</span> <span class="n">newBit</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">clock_getTimerBit</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">CycleCount</span><span class="p">);</span>

    <span class="cm">/* Check for falling edge */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">oldBit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">newBit</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">clock_timerIncrement</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_write_special_cases1" href="#mmu_write_special_cases0">mmu write special cases</a><span class="chunk-index"> (<a href="#mmu_write_special_cases0">0</a> 1 <a href="#mmu_write_special_cases2">2</a> <a href="#mmu_write_special_cases3">3</a> <a href="#mmu_write_special_cases4">4</a> <a href="#mmu_write_special_cases5">5</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">IO_TimerControl</span><span class="p">:</span>
    <span class="n">clock_updateTimerControl</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>When the underlying 16-bit cycle count changes (either when reset or when
incremented by the clock) this affects both the timer counter and the divider
register.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="function_declarations0" href="#function_declarations0">function declarations</a><span class="chunk-index"> (0 <a href="#function_declarations1">1</a> <a href="#function_declarations2">2</a> <a href="#function_declarations3">3</a> <a href="#function_declarations4">4</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clock_countChange</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">new_value</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="clock_functions4" href="#clock_functions0">clock functions</a><span class="chunk-index"> (<a href="#clock_functions0">0</a> <a href="#clock_functions1">1</a> <a href="#clock_functions2">2</a> <a href="#clock_functions3">3</a> 4)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clock_countChange</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">new_value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">tac</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerControl</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">tac</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Timer enable */</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">clock_getTimerBit</span><span class="p">(</span><span class="n">tac</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">clock_getTimerBit</span><span class="p">(</span><span class="n">tac</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">CycleCount</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">clock_timerIncrement</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">CycleCount</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_Divider</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8u</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="per_machine_cycle_updates2" href="#per_machine_cycle_updates0">per machine cycle updates</a><span class="chunk-index"> (<a href="#per_machine_cycle_updates0">0</a> <a href="#per_machine_cycle_updates1">1</a> 2 <a href="#per_machine_cycle_updates3">3</a> <a href="#per_machine_cycle_updates4">4</a>)</span> &gt;&gt=
<span class="n">clock_countChange</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">.</span><span class="n">CycleCount</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_write_special_cases2" href="#mmu_write_special_cases0">mmu write special cases</a><span class="chunk-index"> (<a href="#mmu_write_special_cases0">0</a> <a href="#mmu_write_special_cases1">1</a> 2 <a href="#mmu_write_special_cases3">3</a> <a href="#mmu_write_special_cases4">4</a> <a href="#mmu_write_special_cases5">5</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">IO_Divider</span><span class="p">:</span>
    <span class="n">clock_countChange</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<h1 id="interrupt-handling">Interrupt handling</h1>
<p>There are five interrupts. Each is assigned a bit in the interrupt control registers.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="interrupt_bits_enum0" href="#interrupt_bits_enum0">interrupt bits enum</a> &gt;&gt=
<span class="k">enum</span> <span class="p">{</span>
    <span class="n">Interrupt_VBlank</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
    <span class="n">Interrupt_LCDC</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
    <span class="n">Interrupt_TIMA</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
    <span class="n">Interrupt_Serial</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
    <span class="n">Interrupt_Joypad</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>

    <span class="n">Interrupt_Mask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">,</span>
<span class="p">};</span>
</code></pre>

<p><a name="regff0f"></a>
Interrupts are raised by setting in the appropriate bit in the interrupt flag
register (<code>0xFF0F</code>)</p>
<p>Typically this is done automatically by the Gameboy hardware, but software can
manually set (or clear) interrupts by writing to the interrupt flag register.</p>
<p><a name="regffff"></a>
Each interrupt can be individually disabled by setting the appropriate bits in
the interrupt enable IO register (<code>0xFFFF</code>).</p>
<p>When an interrupt is disabled its service routine will not be called when it is
signalled; its bit will remain set in the interrupt flag register unless it is
manually cleared, and if the interrupt is re-enabled when its bit is set in the
interrupt flag register its service routine will be called.</p>
<p>In addition the CPU has an internal global interrupt enable flag which is
modified by the <code>ei</code>, <code>di</code>, and <code>reti</code> instructions. </p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_registers3" href="#cpu_registers0">cpu registers</a><span class="chunk-index"> (<a href="#cpu_registers0">0</a> <a href="#cpu_registers1">1</a> <a href="#cpu_registers2">2</a> 3 <a href="#cpu_registers4">4</a> <a href="#cpu_registers5">5</a> <a href="#cpu_registers6">6</a>)</span> &gt;&gt=
<span class="kt">bool</span> <span class="n">InterruptsEnabled</span><span class="p">;</span>
</code></pre>

<p>The CPU services an interrupt by calling to a fixed address for each interrupt,
with interrupts disabled. An interrupt routine will typically return using the
<code>reti</code> instruction, which returns to the address on the top of the stack and
re-enables interrupts. Interrupts are serviced in order, from low bit to high
bit (<code>VBlank</code> to <code>Joypad</code>). The interrupt service routine table starts at
address <code>0x40</code> and provides 8 bytes per interrupt. When an interrupt is serviced
its bit is cleared from the interrupt flag register.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="service_highest_priority_interrupt0" href="#service_highest_priority_interrupt0">service highest priority interrupt</a> &gt;&gt=
<span class="c1">// handle interrupts in priority order</span>
<span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">irqs</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptsEnabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
        <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
        <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
        <span class="n">iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">=</span> <span class="n">iflag</span><span class="p">;</span>
</code></pre>

<p>When any enabled interrupt is raised it will bring the CPU out of halt mode to
service it, if required.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="interrupt_handler_function0" href="#interrupt_handler_function0">interrupt handler function</a> &gt;&gt=
<span class="kt">void</span> <span class="nf">cpu_handleInterrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">iflag</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="n">irqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">InterruptEnable</span> <span class="o">&amp;</span> <span class="n">iflag</span> <span class="o">&amp;</span> <span class="n">Interrupt_Mask</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">irqs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">Halted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptsEnabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptEnablePending</span><span class="p">);</span>
            &lt;&lt <a href="#service_highest_priority_interrupt0">service highest priority interrupt</a> &gt;&gt;
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_write_special_cases3" href="#mmu_write_special_cases0">mmu write special cases</a><span class="chunk-index"> (<a href="#mmu_write_special_cases0">0</a> <a href="#mmu_write_special_cases1">1</a> <a href="#mmu_write_special_cases2">2</a> 3 <a href="#mmu_write_special_cases4">4</a> <a href="#mmu_write_special_cases5">5</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">IO_InterruptFlag</span><span class="p">:</span>
    <span class="cm">/* Top 5 bits of IF always read 1s */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">|</span> <span class="mh">0xE0</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<h1 id="cpu-emulation">CPU Emulation</h1>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_functions0" href="#cpu_functions0">cpu functions</a> &gt;&gt=
&lt;&lt <a href="#cpu_helpers0">cpu helpers</a> &gt;&gt;
&lt;&lt <a href="#interrupt_handler_function0">interrupt handler function</a> &gt;&gt;
&lt;&lt <a href="#cpu_step0">cpu step</a> &gt;&gt;
</code></pre>

<h2 id="operand-types">Operand Types</h2>
<p>Registers</p>
<ul>
<li><code>$reg8</code> - one of the 8-bit registers <code>A</code>, <code>B</code>, <code>D</code>, <code>E</code>, <code>H</code>, <code>L</code></li>
<li><code>$reg16</code> - one of the 16-bit register pairs <code>AF</code>, <code>DE</code>, <code>HL</code></li>
</ul>
<p>Immediate values directly follow the opcode in the instruction stream</p>
<ul>
<li><code>imm8</code> - an 8-bit unsigned immediate operand</li>
<li><code>imm8i</code> - an 8-bit signed immediate operand</li>
<li><code>imm16</code> - a 16-bit immediate operand (little endian)</li>
</ul>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers0" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (0 <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint8_t</span> <span class="nf">Imm8</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int8_t</span> <span class="nf">Imm8i</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">int8_t</span><span class="p">)</span><span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint16_t</span> <span class="nf">Imm16</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8u</span><span class="p">)</span> <span class="o">|</span> <span class="n">lo</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>Memory read/write is indicated by surrounding a operand description with
parenthesis, e.g. <code>(imm16)</code> refers to the data at memory address <code>imm16</code>.</p>
<p>Many instructions operate on a pair of registers as a single 16 bit value. There
are four possible pairings of the the Gameboy CPU registers: <code>AF</code>, <code>BC</code>, <code>DE</code>
and <code>HL</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers1" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> 1 <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">uint16_t</span> <span class="nf">ReadAF</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">uint16_t</span> <span class="nf">ReadBC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">uint16_t</span> <span class="nf">ReadDE</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">uint16_t</span> <span class="nf">ReadHL</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">WriteAF</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">af</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">af</span> <span class="o">&gt;&gt;</span> <span class="mi">8u</span><span class="p">);</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">af</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">WriteBC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">bc</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&gt;&gt;</span> <span class="mi">8u</span><span class="p">);</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">WriteDE</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">de</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">de</span> <span class="o">&gt;&gt;</span> <span class="mi">8u</span><span class="p">);</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="n">de</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">WriteHL</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">hl</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">hl</span> <span class="o">&gt;&gt;</span> <span class="mi">8u</span><span class="p">);</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">hl</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="p">}</span>
</code></pre>

<p>The flags register in the CPU contains four well-defined bits, and many
instructions read and/or write one or more of those bits.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers2" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> 2 <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">UpdateZ</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">UpdateN</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">UpdateH</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">UpdateC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

<span class="kt">bool</span> <span class="nf">ReadZ</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">bool</span> <span class="nf">ReadN</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">bool</span> <span class="nf">ReadH</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">bool</span> <span class="nf">ReadC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">UpdateZNHC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">z</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">n</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">h</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UpdateZ</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
    <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
    <span class="n">UpdateC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>The CPU has instructions which push and pop 16-bit values from a stack, the top
of which is pointed to by the <code>SP</code> register. The stack grows towards address
zero as items and pushed onto it. The bytes within the 16-bit values are
arranged in little-endian order.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers3" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> 3 <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">Push16</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">val</span><span class="p">));</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8u</span><span class="p">));</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint16_t</span> <span class="nf">Pop16</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">val</span> <span class="o">|=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>The main CPU loop executes a single instruction. Most of the implementation is a
large switch statement, with one case for each instruction encoding.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_step0" href="#cpu_step0">cpu step</a> &gt;&gt=
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">mmu_readDirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">cpu_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    &lt;&lt <a href="#halt_emulation0">halt emulation</a> &gt;&gt;

    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptEnablePending</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptsEnabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptEnablePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>

    <span class="n">GBTRACE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameboy_tp</span><span class="p">){</span> <span class="p">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">GAMEBOY_TP_INSTR_START</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">instr_start</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}));</span>

    &lt;&lt <a href="#halt_bug_emulation0">halt bug emulation</a> &gt;&gt;

    <span class="k">switch</span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
    &lt;&lt <a href="#cpu_instructions0">cpu instructions</a> &gt;&gt;

        <span class="k">default</span><span class="o">:</span>
            <span class="n">raise</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The number of cycles to execute an instruction is generally just the number of
cycles to read all the bytes of the instruction. For taken jumps there is an
additional 4 cycles, and 16bit arithmetic (e.g. adding two register pairs)
appears to take an extra 4 cycles.</p>
<h2 id="load-instructions-ld">Load instructions (<code>ld</code>)</h2>
<p><a name="op_ldrr"></a></p>
<h3 id="register-to-register">Register-to-register</h3>
<p>A large number of instructions simply copy data from one register to another.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions0" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (0 <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// ld $b, $reg8</span>
<span class="k">case</span> <span class="mh">0x40</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x41</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x42</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x43</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x44</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x45</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x47</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld $c, $reg8</span>
<span class="k">case</span> <span class="mh">0x48</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x49</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x4A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x4B</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x4C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x4D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x4F</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld $d, $reg8</span>
<span class="k">case</span> <span class="mh">0x50</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x51</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x52</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x53</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x54</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x55</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x57</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld $e, $reg8</span>
<span class="k">case</span> <span class="mh">0x58</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x59</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x5A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x5B</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x5C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x5D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x5F</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld $h, $reg8</span>
<span class="k">case</span> <span class="mh">0x60</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x61</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x62</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x63</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x64</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x65</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x67</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld $l, $reg8</span>
<span class="k">case</span> <span class="mh">0x68</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x69</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x6A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x6B</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x6C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x6D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x6F</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld $a, $reg8</span>
<span class="k">case</span> <span class="mh">0x78</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x79</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x7A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x7B</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x7C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x7D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x7F</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h3 id="memory-to-register-and-register-to-memory">Memory-to-Register and Register-to-Memory</h3>
<p><a name="op_ldrm"></a><a name="op_ldmr"></a>
Each register can be loaded with a single byte from memory, using the <code>HL</code>
register pair to specify the memory address. Conversely register values can be
stored to the address specified by <code>HL</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions1" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> 1 <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// ld $reg8, ($hl)</span>
<span class="k">case</span> <span class="mh">0x46</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x4E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x56</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x5E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x66</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x6E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x7E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld ($hl), $reg8</span>
<span class="k">case</span> <span class="mh">0x70</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x71</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x72</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x73</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x74</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x75</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x77</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>An immediate value can be stored to memory at address <code>HL</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions2" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> 2 <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x36</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ld ($hl), imm8</span>
</code></pre>

<p><a name="op_ldam"></a><a name="op_ldma"></a>
In addition there are more memory load/store instructions which are available only for the <code>A</code> register.</p>
<p>The register pairs <code>BC</code> and <code>DE</code> can be used to specify memory addresses:</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions3" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> 3 <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// ld $a, ($reg16)</span>
<span class="k">case</span> <span class="mh">0x0A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadBC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x1A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadDE</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// ld ($reg16), $a</span>
<span class="k">case</span> <span class="mh">0x02</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadBC</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x12</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadDE</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>An immediate address can be used for load/store of <code>A</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions4" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> 4 <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xEA</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ld (imm16), $a</span>
<span class="k">case</span> <span class="mh">0xFA</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ld $a, (imm16)</span>
</code></pre>

<p>There are special variants of the indirect memory loads <code>ld ($hl), $a</code> and <code>ld $a, ($hl)</code> which perform the load and increment or decrement the value of <code>HL</code> in the same instruction.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions5" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> 5 <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x22</span><span class="o">:</span> <span class="c1">// ld ($hl+), $a</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x2A</span><span class="o">:</span> <span class="c1">// ld $a, ($hl+)</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x32</span><span class="o">:</span> <span class="c1">// ld ($hl-), $a</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x3A</span><span class="o">:</span> <span class="c1">// ld $a, ($hl-)</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Special variants of the immediate addressed load/stores are available which
load/store to an address at an unsigned 8bit offset from <code>0xFF00</code>. These are
usually referred to as "high memory loads".</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions6" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> 6 <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xE0</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0xFF00</span> <span class="o">+</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ld (0xFF00 + imm8), $a</span>
<span class="k">case</span> <span class="mh">0xE2</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0xFF00</span> <span class="o">+</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ld (0xFF00 + $c), $a</span>
<span class="k">case</span> <span class="mh">0xF0</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0xFF00</span> <span class="o">+</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ld $a, (0xFF00 + imm8)</span>
<span class="k">case</span> <span class="mh">0xF2</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0xFF00</span> <span class="o">+</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ld $a, (0xFF00 + $c)</span>
</code></pre>

<h3 id="immediate-to-register">Immediate-to-Register</h3>
<p><a name="op_ldri"></a>Each register can be loaded with an immediate value.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions7" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> 7 <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// ld $reg8, imm8</span>
<span class="k">case</span> <span class="mh">0x06</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x0E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x16</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x1E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x26</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x2E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x3E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>The 16-bit register pairs <code>BC</code>, <code>DE</code>, <code>HL</code> and the stack pointer <code>SP</code> can be loaded with immediate values.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions8" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> 8 <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// ld $reg16, imm16</span>
<span class="k">case</span> <span class="mh">0x01</span><span class="o">:</span> <span class="n">WriteBC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x11</span><span class="o">:</span> <span class="n">WriteDE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x21</span><span class="o">:</span> <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x31</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">=</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h2 id="stack-and-stack-pointer">Stack and Stack Pointer</h2>
<p>The stack pointer (<code>SP</code>) can be set to an immediate value or the value of <code>HL</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions9" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> 9 <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x08</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// ld (imm16), $sp</span>
    <span class="kt">uint16_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">&gt;&gt;</span> <span class="mi">8u</span><span class="p">));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xF9</span><span class="o">:</span> <span class="c1">// ld $sp, $hl</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">=</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Bytes can be loaded from an address relative to the stack pointer.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions10" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> 10 <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xF8</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// ld $hl, ($sp + imm8)</span>
    <span class="kt">uint16_t</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">+</span> <span class="n">Imm8i</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ea</span><span class="p">);</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">ea</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">),</span> <span class="p">(</span><span class="n">ea</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h3 id="stack-pushpop">Stack push/pop</h3>
<p>Each of the register pairs <code>BC</code>, <code>DE</code>, <code>HL</code> and <code>AF</code> can be pushed and popped
to/from the stack. Pushing a register pair takes an additional machine cycle.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions11" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> 11 <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// pop $reg16</span>
<span class="k">case</span> <span class="mh">0xC1</span><span class="o">:</span> <span class="n">WriteBC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Pop16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xD1</span><span class="o">:</span> <span class="n">WriteDE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Pop16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xE1</span><span class="o">:</span> <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Pop16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xF1</span><span class="o">:</span> <span class="n">WriteAF</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Pop16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// push $reg16</span>
<span class="k">case</span> <span class="mh">0xC5</span><span class="o">:</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">Push16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadBC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xD5</span><span class="o">:</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">Push16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadDE</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xE5</span><span class="o">:</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">Push16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xF5</span><span class="o">:</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">Push16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadAF</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<h2 id="8bit-arithmetic">8bit Arithmetic</h2>
<p>Addition of two 8 bit values is quite straight-forward. The output flags are calculated in a logical manner:
 - <code>Z</code> flag is set when the output is zero
 - <code>N</code> flag is cleared
 - <code>H</code> flag is set if there is a carry from the bottom nibble addition
 - <code>C</code> flag is set if there is a carry from the whole byte addition</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers4" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> 4 <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="nf">Add8</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val0</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val1</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">carry</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">val0</span> <span class="o">+</span> <span class="n">val1</span> <span class="o">+</span> <span class="n">carry</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">halfSum</span> <span class="o">=</span> <span class="p">(</span><span class="n">val0</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">+</span> <span class="n">carry</span><span class="p">;</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">halfSum</span> <span class="o">&gt;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="n">sum</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>The <code>add</code> instruction adds two 8-bit operands, ignoring the current value of the carry flag.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions12" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> 12 <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// add $a, reg8</span>
<span class="k">case</span> <span class="mh">0x80</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x81</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x82</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x83</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x84</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x85</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x87</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// add $a, ($hl)</span>
<span class="k">case</span> <span class="mh">0x86</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)),</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// add $a, imm8</span>
<span class="k">case</span> <span class="mh">0xC6</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>The <code>adc</code> (add with carry) instruction adds the two operands and the current
value of the carry flag together. This allow implementation of extended
precision arithmetic by chaining multiple <code>add</code>/<code>adc</code> instructions.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions13" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> 13 <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// adc $a, reg8</span>
<span class="k">case</span> <span class="mh">0x88</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x89</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x8A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x8B</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x8C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x8D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x8F</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// adc $a, ($hl)</span>
<span class="k">case</span> <span class="mh">0x8E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)),</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// adc $a, imm8</span>
<span class="k">case</span> <span class="mh">0xCE</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Add8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Eight bit subtraction is very similar to addition; the meaning of the carry and
half-carry flags are better described as borrow and half-borrow.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers5" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> 5 <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="nf">Sub8</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val0</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val1</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">carry</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">val0</span> <span class="o">-</span> <span class="n">val1</span> <span class="o">-</span> <span class="n">carry</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">halfSum</span> <span class="o">=</span> <span class="p">(</span><span class="n">val0</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">-</span> <span class="n">carry</span><span class="p">;</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">halfSum</span> <span class="o">&gt;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="n">sum</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>The <code>sub</code> instruction subtracts two 8-bit operands, ignoring the current flags.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions14" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> 14 <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// sub $a, reg8</span>
<span class="k">case</span> <span class="mh">0x90</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x91</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x92</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x93</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x94</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x95</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x97</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// sub $a, ($hl)</span>
<span class="k">case</span> <span class="mh">0x96</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)),</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// sub $a, imm8</span>
<span class="k">case</span> <span class="mh">0xD6</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>The <code>sbc</code> (subtract with carry) subtracts two 8-bit operands and the current value of the carry flag.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions15" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> 15 <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// sbc $a, reg8</span>
<span class="k">case</span> <span class="mh">0x98</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x99</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x9A</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x9B</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x9C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x9D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x9F</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// sbc $a, ($hl)</span>
<span class="k">case</span> <span class="mh">0x9E</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)),</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// sbc $a, imm8</span>
<span class="k">case</span> <span class="mh">0xDE</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Increment adds one to a register, but never considers or updates the carry flag.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers6" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> 6 <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="nf">Inc8</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UpdateZ</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">);</span>
    <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xF</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions16" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> 16 <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// inc reg8</span>
<span class="k">case</span> <span class="mh">0x04</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x0C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x14</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x1C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x24</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x2C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x3C</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Conversely decrement subtracts one from a register, not considering or updating the carry flag.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers7" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> 7 <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="nf">Dec8</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UpdateZ</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">);</span>
    <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions17" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> 17 <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// dec reg8</span>
<span class="k">case</span> <span class="mh">0x05</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x0D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x15</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x1D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x25</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x2D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x3D</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>The <code>cp</code> (compare) instruction performs a subtraction between two registers, but
does not store the result: its only change to the CPU state is to update the
flag register. This instruction is principally used to form the predicate for a
conditional jump.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions18" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> 18 <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// cp $a, reg8</span>
<span class="k">case</span> <span class="mh">0xB8</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB9</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xBA</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xBB</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xBC</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xBD</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xBF</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// cp $a, ($hl)</span>
<span class="k">case</span> <span class="mh">0xBE</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)),</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="c1">// cp $a, imm8</span>
<span class="k">case</span> <span class="mh">0xFE</span><span class="o">:</span> <span class="n">Sub8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h2 id="bitwise-boolean-logic-operations">Bitwise boolean logic operations</h2>
<p>Bitwise <code>and</code>, <code>or</code> and <code>xor</code> all set the <code>Z</code> flag to reflect if the result is zero. Other flags are set to fixed values.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers8" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> 8 <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">BitAnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&amp;=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">BitOr</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">BitXor</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">^=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions19" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> 19 <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="c1">// and/or/xor $a, $reg8</span>
<span class="k">case</span> <span class="mh">0xA0</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA1</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA2</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA3</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA4</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA5</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA7</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB0</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB1</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB2</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB3</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB4</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB5</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB7</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA8</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xA9</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xAA</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xAB</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xAC</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xAD</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xAF</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// and/or/xor $a, ($hl)</span>
<span class="k">case</span> <span class="mh">0xA6</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xB6</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xAE</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)));</span> <span class="k">break</span><span class="p">;</span>

<span class="c1">// and/or/xor $a, imm8</span>
<span class="k">case</span> <span class="mh">0xE6</span><span class="o">:</span> <span class="n">BitAnd</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xF6</span><span class="o">:</span> <span class="n">BitOr</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xEE</span><span class="o">:</span> <span class="n">BitXor</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Single bit rotate left &amp; right of <code>A</code></p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions20" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> 20 <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x07</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rlca</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&gt;&gt;</span> <span class="mi">7u</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x0F</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rrca</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&gt;&gt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="mi">7u</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Single bit rotate left &amp; right of <code>A</code>, considering the carry flag as an extra
bit (the most significant) of <code>A</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions21" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> 21 <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x17</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rla</span>
    <span class="kt">bool</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span><span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x1F</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rra</span>
    <span class="kt">bool</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">&gt;&gt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span><span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>Complement (bitwise invert) all bits in <code>A</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions22" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> 22 <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x2F</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// cpl</span>
    <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">^=</span> <span class="n">UINT8_MAX</span><span class="p">;</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h3 id="extended-bitwise-operations-0xcb">Extended Bitwise Operations (<code>0xCB</code>)</h3>
<p>The CPU provides an additional set of bitwise operations via an extended
instruction sequence: the <code>0xCB</code> is a two-byte instruction which performs an
operation determined by the second byte. The operation encoding is quite
regular: the bits of the extension byte (MSB to LSB) <code>OOIIIRRR</code> encode a 2bit
operation field <code>OO</code>, a three bit sub-operation or bit index (<code>III</code>), and a
three bit register index (<code>RRR</code>).</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions23" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> 23 <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xCB</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">cpu_cb_op</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>The register operated on is selected by the register field:</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Register</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>B</td>
</tr>
<tr>
<td>1</td>
<td>C</td>
</tr>
<tr>
<td>2</td>
<td>D</td>
</tr>
<tr>
<td>3</td>
<td>E</td>
</tr>
<tr>
<td>4</td>
<td>H</td>
</tr>
<tr>
<td>5</td>
<td>L</td>
</tr>
<tr>
<td>6</td>
<td>(HL) - memory at address HL</td>
</tr>
<tr>
<td>7</td>
<td>A</td>
</tr>
</tbody>
</table>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers9" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> 9 <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="nf">ReadRegN</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regNum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">regNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">5</span><span class="o">:</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">6</span><span class="o">:</span> <span class="k">return</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
        <span class="k">case</span> <span class="mi">7</span><span class="o">:</span> <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">WriteRegN</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regNum</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">newVal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">regNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">5</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">6</span><span class="o">:</span> <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">newVal</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">7</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers10" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> 10 <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">cpu_cb_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">cb_opcode</span> <span class="o">=</span> <span class="n">Imm8</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>

    <span class="c1">// XX XXX XXX</span>
    <span class="c1">// ~~ operation</span>
    <span class="c1">//    ~~~ bit index or sub-operation</span>
    <span class="c1">//        ~~~ register</span>
    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">op</span> <span class="o">=</span> <span class="n">cb_opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">6u</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">3u</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">cb_opcode</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// shift/rotate &amp; swap</span>
            <span class="k">switch</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rlc rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">7u</span><span class="p">);</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rrc rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">7u</span><span class="p">);</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rl rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="kt">uint8_t</span> <span class="n">rotated</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">rotated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">rotated</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// rr rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="kt">uint8_t</span> <span class="n">rotated</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span><span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">rotated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">rotated</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// sla rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="kt">uint8_t</span> <span class="n">shifted</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1u</span><span class="p">;</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">shifted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shifted</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">5</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// sra rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="kt">uint8_t</span> <span class="n">shifted</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="n">shifted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shifted</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">6</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// swap rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4u</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4u</span><span class="p">);</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="mi">7</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// srl rN</span>
                    <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                    <span class="kt">uint8_t</span> <span class="n">shifted</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1u</span><span class="p">;</span>
                    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">shifted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
                    <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">shifted</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// bit n, rN</span>
            <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
            <span class="n">UpdateZ</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
            <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// res n, rN</span>
            <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
            <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)));</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// set n, rN</span>
            <span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
            <span class="n">WriteRegN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)));</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h2 id="16-bit-arithemtic">16 bit arithemtic</h2>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers11" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> 11 <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">uint16_t</span> <span class="nf">Add16</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">val0</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">val1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">val0</span> <span class="o">+</span> <span class="n">val1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">halfSum</span> <span class="o">=</span> <span class="p">(</span><span class="n">val0</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">);</span>
    <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">halfSum</span> <span class="o">&gt;</span> <span class="mh">0xFFF</span><span class="p">);</span>
    <span class="n">UpdateC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">sum</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions24" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> 24 <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x03</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// inc $bc</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteBC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadBC</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x13</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// inc $de</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteDE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadDE</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x23</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// inc $hl</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x33</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// inc $sp</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions25" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> 25 <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x0B</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// dec $bc</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteBC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadBC</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x1B</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// dec $de</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteDE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadDE</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x2B</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// dec $hl</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x3B</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// dec $sp</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions26" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> 26 <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x09</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// add $hl, $bc</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Add16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadBC</span><span class="p">(</span><span class="n">gb</span><span class="p">)));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x19</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// add $hl, $de</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Add16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadDE</span><span class="p">(</span><span class="n">gb</span><span class="p">)));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x29</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// add $hl, $hl</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Add16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">)));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x39</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// add $hl, $sp</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">WriteHL</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Add16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span><span class="p">));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0xE8</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// add $sp, imm8i</span>
    <span class="kt">uint16_t</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">+</span> <span class="n">Imm8i</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">UpdateZNHC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="n">ea</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">),</span> <span class="p">(</span><span class="n">ea</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">=</span> <span class="n">ea</span><span class="p">;</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions27" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> 27 <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x34</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// inc ($hl)</span>
    <span class="kt">uint16_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Inc8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">)));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x35</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// dec ($hl)</span>
    <span class="kt">uint16_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">mmu_write</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Dec8</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">)));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h2 id="branchjump-jr-jp">Branch/Jump (<code>jr</code>, <code>jp</code>)</h2>
<p>Jump instructions modify the program counter, determining which instruction will
be executed next. Jumps can be conditional, in which case the modification of
the program counter only happens (the jump is <em>taken</em>) if the attached condition is true.</p>
<p>Possible conditions are:</p>
<ul>
<li><code>z</code> Zero flag is set in the flags register</li>
<li><code>nz</code> Zero flag is <em>not</em> set in the flags register</li>
<li><code>c</code> Carry flag is set in the flags register</li>
<li><code>nc</code> Carry flag is <em>not</em> set in the flags register</li>
</ul>
<p>When a jump is taken there is a delay of a single machine cycle in addition to
the normal instruction fetch delay.</p>
<p>The "target" of a jump is the value which the program counter will be set to if
the jump is taken. The target can be specified as either a relative or absolute
address.</p>
<p>Absolute jump instructions (<code>jp</code>) simply copy the target address directly into
the program counter.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers12" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> 12 <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">Jump</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">JumpCond</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Jump</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions28" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> 28 <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xE9</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">=</span> <span class="n">ReadHL</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jp $hl</span>
<span class="k">case</span> <span class="mh">0xC3</span><span class="o">:</span> <span class="n">Jump</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jp imm16</span>
<span class="k">case</span> <span class="mh">0xC2</span><span class="o">:</span> <span class="n">JumpCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="o">!</span><span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jp nz, imm16</span>
<span class="k">case</span> <span class="mh">0xCA</span><span class="o">:</span> <span class="n">JumpCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jp z, imm16</span>
<span class="k">case</span> <span class="mh">0xD2</span><span class="o">:</span> <span class="n">JumpCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="o">!</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jp nc, imm16</span>
<span class="k">case</span> <span class="mh">0xDA</span><span class="o">:</span> <span class="n">JumpCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jp c, imm16</span>
</code></pre>

<p>Relative jump instructions (<code>jr</code>) specify a signed offset which is added to the current value of the program counter. The program counter has already been advanced when this addition takes place, so the offset is relative to the address of the instruction immediately following the <code>jr</code> instruction.</p>
<pre><code>0x00: jr +4
0x01: add a, 1
0x03: add a, 1
; execution will begin here, at 0x01 + 4
0x05: add a, 1
</code></pre>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers13" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> 13 <a href="#cpu_helpers14">14</a> <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">JumpRel</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">JumpRelCond</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">JumpRel</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions29" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> 29 <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x18</span><span class="o">:</span> <span class="n">JumpRel</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8i</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jr imm8</span>
<span class="k">case</span> <span class="mh">0x20</span><span class="o">:</span> <span class="n">JumpRelCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8i</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="o">!</span><span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jr nz, imm8</span>
<span class="k">case</span> <span class="mh">0x28</span><span class="o">:</span> <span class="n">JumpRelCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8i</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jr z, imm8i</span>
<span class="k">case</span> <span class="mh">0x30</span><span class="o">:</span> <span class="n">JumpRelCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8i</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="o">!</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jr nc, imm8i</span>
<span class="k">case</span> <span class="mh">0x38</span><span class="o">:</span> <span class="n">JumpRelCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm8i</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// jr c, imm8i</span>
</code></pre>

<h2 id="call-and-return-call-ret">Call and Return (<code>call</code>, <code>ret</code>)</h2>
<p>Call instructions push the address of the next instruction to be executed onto
the stack and then jump to the specified address. e.g.</p>
<pre><code>; if nz:
;   push 0x2003
;   jmp 0xC345
0x2000: call nz, 0xC345
0x2003: xor a, a
</code></pre>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers14" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> 14 <a href="#cpu_helpers15">15</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">Call</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">Push16</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">CallCond</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions30" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> 30 <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xC4</span><span class="o">:</span> <span class="n">CallCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="o">!</span><span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// call nz, imm16</span>
<span class="k">case</span> <span class="mh">0xCC</span><span class="o">:</span> <span class="n">CallCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// call z, imm16</span>
<span class="k">case</span> <span class="mh">0xD4</span><span class="o">:</span> <span class="n">CallCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="o">!</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// call nc, imm16</span>
<span class="k">case</span> <span class="mh">0xDC</span><span class="o">:</span> <span class="n">CallCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">),</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// call c, imm16</span>

<span class="k">case</span> <span class="mh">0xCD</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Imm16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// call imm16</span>
</code></pre>

<p>The reset group of instructions are single-byte instructions which unconditionally call a fixed address.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions31" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> 31 <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xC7</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x00</span>
<span class="k">case</span> <span class="mh">0xCF</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x08</span>
<span class="k">case</span> <span class="mh">0xD7</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x10</span>
<span class="k">case</span> <span class="mh">0xDF</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x18</span>
<span class="k">case</span> <span class="mh">0xE7</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x20</span>
<span class="k">case</span> <span class="mh">0xEF</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x28</span>
<span class="k">case</span> <span class="mh">0xF7</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x30</span>
<span class="k">case</span> <span class="mh">0xFF</span><span class="o">:</span> <span class="n">Call</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// rst 0x38</span>
</code></pre>

<p>Return (<code>ret</code>) instructions pop an address from the stack and then jump to it.</p>
<pre><code>; if nz:
;   addr = pop16
;   jmp addr
ret nz
</code></pre>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_helpers15" href="#cpu_helpers0">cpu helpers</a><span class="chunk-index"> (<a href="#cpu_helpers0">0</a> <a href="#cpu_helpers1">1</a> <a href="#cpu_helpers2">2</a> <a href="#cpu_helpers3">3</a> <a href="#cpu_helpers4">4</a> <a href="#cpu_helpers5">5</a> <a href="#cpu_helpers6">6</a> <a href="#cpu_helpers7">7</a> <a href="#cpu_helpers8">8</a> <a href="#cpu_helpers9">9</a> <a href="#cpu_helpers10">10</a> <a href="#cpu_helpers11">11</a> <a href="#cpu_helpers12">12</a> <a href="#cpu_helpers13">13</a> <a href="#cpu_helpers14">14</a> 15)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">Ret</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Jump</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">Pop16</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">RetCond</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cond</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Ret</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions32" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> 32 <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xC9</span><span class="o">:</span> <span class="n">Ret</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ret</span>
<span class="k">case</span> <span class="mh">0xC0</span><span class="o">:</span> <span class="n">RetCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="o">!</span><span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ret nz</span>
<span class="k">case</span> <span class="mh">0xC8</span><span class="o">:</span> <span class="n">RetCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadZ</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ret z</span>
<span class="k">case</span> <span class="mh">0xD0</span><span class="o">:</span> <span class="n">RetCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="o">!</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ret nc</span>
<span class="k">case</span> <span class="mh">0xD8</span><span class="o">:</span> <span class="n">RetCond</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ret c</span>
<span class="k">case</span> <span class="mh">0xD9</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// reti</span>
    <span class="n">Ret</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptsEnabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h2 id="misc-instructions">Misc instructions</h2>
<p><a name="op_00_nop"></a>The simplest instruction is <code>nop</code> (no operation), which does nothing.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions33" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> 33 <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x00</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// nop</span>
</code></pre>

<h3 id="interrupt-enabledisable">Interrupt Enable/Disable</h3>
<p>There are instructions which disable and enable interrupts. Note there is a
specific <code>ret</code> instruction variant (<code>reti</code>) which performs a <code>ret</code> and <code>ei</code>.
The <code>ei</code> instruction has a delay of a single instruction before taking effect; e.g</p>
<pre><code>di
...
ei
inc a
inc a
</code></pre>
<p>Will always execute at least one <code>inc a</code> even if there is an interrupt pending
when <code>ei</code> is executed.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_registers4" href="#cpu_registers0">cpu registers</a><span class="chunk-index"> (<a href="#cpu_registers0">0</a> <a href="#cpu_registers1">1</a> <a href="#cpu_registers2">2</a> <a href="#cpu_registers3">3</a> 4 <a href="#cpu_registers5">5</a> <a href="#cpu_registers6">6</a>)</span> &gt;&gt=
<span class="kt">bool</span> <span class="n">InterruptEnablePending</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions34" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> 34 <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0xF3</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptsEnabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptEnablePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">break</span><span class="p">;</span> <span class="c1">// di</span>
<span class="k">case</span> <span class="mh">0xFB</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptEnablePending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ei</span>
</code></pre>

<h3 id="halt">Halt</h3>
<p>The <code>halt</code> instruction is used to halt the CPU until an interrupt is received.
Whilst halted the CPU enters a lower power state and does not execute any
instructions, however the clock still runs and all other parts of the system
continue as normal.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions35" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> 35 <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x76</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// halt</span>
    &lt;&lt <a href="#halt_handling0">halt handling</a> &gt;&gt;
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>To emulate this a flag is stored in the CPU state:</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_registers5" href="#cpu_registers0">cpu registers</a><span class="chunk-index"> (<a href="#cpu_registers0">0</a> <a href="#cpu_registers1">1</a> <a href="#cpu_registers2">2</a> <a href="#cpu_registers3">3</a> <a href="#cpu_registers4">4</a> 5 <a href="#cpu_registers6">6</a>)</span> &gt;&gt=
<span class="kt">bool</span> <span class="n">Halted</span><span class="p">;</span>
</code></pre>

<p>This flag is set by the <code>halt</code> instruction:</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="halt_handling0" href="#halt_handling0">halt handling</a><span class="chunk-index"> (0 <a href="#halt_handling1">1</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">Halted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</code></pre>

<p>When the CPU is halted the CPU emulation function only advances the system clock.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="halt_emulation0" href="#halt_emulation0">halt emulation</a> &gt;&gt=
<span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">Halted</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>There is a bug in the CPU which is triggered when a <code>halt</code> instruction is
executed and interrupts are disabled. In this situation the halt state will
still be exited when an interrupt fires, but the program counter is not advanced
after reading the initial instruction byte of the subsequent instruction. So, for example, the code</p>
<pre><code>0xf3 ; di
0x76 ; halt
0x3c ; inc a
</code></pre>
<p>actually increments the <code>a</code> register twice. This bug is especially dangerous for
multi-byte instructions, as the initial instruction byte will be re-read as the
first extension byte; e.g.</p>
<pre><code>0xf3 ; di
0x76 ; halt
0xee 0x0a ; xor a,0x0a
</code></pre>
<p>will execute as</p>
<pre><code>0xf3 ; di
0x76 ; halt
0xee 0xee ; xor a,0xee
0x0a ; ld a, (bc)
</code></pre>
<p>To emulate this behaviour another flag is added to the CPU state, which is set
when entering halt mode with interrupts disabled.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_registers6" href="#cpu_registers0">cpu registers</a><span class="chunk-index"> (<a href="#cpu_registers0">0</a> <a href="#cpu_registers1">1</a> <a href="#cpu_registers2">2</a> <a href="#cpu_registers3">3</a> <a href="#cpu_registers4">4</a> <a href="#cpu_registers5">5</a> 6)</span> &gt;&gt=
<span class="kt">bool</span> <span class="n">HaltBug</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="halt_handling1" href="#halt_handling0">halt handling</a><span class="chunk-index"> (<a href="#halt_handling0">0</a> 1)</span> &gt;&gt=
<span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptsEnabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">HaltBug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>Then immediately after reading the first instruction byte of the next executed
instruction (which will happen when an interrupt fires and the CPU leave halt
mode) this flag is checked and the program counter adjuested appropriately.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="halt_bug_emulation0" href="#halt_bug_emulation0">halt bug emulation</a> &gt;&gt=
<span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">HaltBug</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">HaltBug</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<h3 id="decimal-adjust-accumulator">Decimal Adjust Accumulator</h3>
<p>This instruction is used after adding two binary-coded-decimal (BCD) numbers
using the binary addition instructions to convert the result to a BCD result.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions36" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> 36 <a href="#cpu_instructions37">37</a> <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x27</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// daa</span>
    <span class="kt">uint16_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ReadN</span><span class="p">(</span><span class="n">gb</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ReadH</span><span class="p">(</span><span class="n">gb</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">a</span> <span class="o">-=</span> <span class="mh">0x06</span><span class="p">;</span>
            <span class="n">a</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">a</span> <span class="o">-=</span> <span class="mh">0x60</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">((</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x09</span> <span class="o">||</span> <span class="n">ReadH</span><span class="p">(</span><span class="n">gb</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">a</span> <span class="o">+=</span> <span class="mh">0x06</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mh">0x9F</span> <span class="o">||</span> <span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">a</span> <span class="o">+=</span> <span class="mh">0x60</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">UpdateZ</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span> <span class="n">UpdateC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="p">}</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h3 id="stop">Stop</h3>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions37" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> 37 <a href="#cpu_instructions38">38</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x10</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// stop 0</span>
    <span class="c1">// TODO STOP</span>
    <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h3 id="set-complement-carry-flag">Set &amp; Complement Carry Flag</h3>
<p>These instructions set (<code>scf</code>) or toggle (complement) (<code>ccf</code>) the carry flag.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="cpu_instructions38" href="#cpu_instructions0">cpu instructions</a><span class="chunk-index"> (<a href="#cpu_instructions0">0</a> <a href="#cpu_instructions1">1</a> <a href="#cpu_instructions2">2</a> <a href="#cpu_instructions3">3</a> <a href="#cpu_instructions4">4</a> <a href="#cpu_instructions5">5</a> <a href="#cpu_instructions6">6</a> <a href="#cpu_instructions7">7</a> <a href="#cpu_instructions8">8</a> <a href="#cpu_instructions9">9</a> <a href="#cpu_instructions10">10</a> <a href="#cpu_instructions11">11</a> <a href="#cpu_instructions12">12</a> <a href="#cpu_instructions13">13</a> <a href="#cpu_instructions14">14</a> <a href="#cpu_instructions15">15</a> <a href="#cpu_instructions16">16</a> <a href="#cpu_instructions17">17</a> <a href="#cpu_instructions18">18</a> <a href="#cpu_instructions19">19</a> <a href="#cpu_instructions20">20</a> <a href="#cpu_instructions21">21</a> <a href="#cpu_instructions22">22</a> <a href="#cpu_instructions23">23</a> <a href="#cpu_instructions24">24</a> <a href="#cpu_instructions25">25</a> <a href="#cpu_instructions26">26</a> <a href="#cpu_instructions27">27</a> <a href="#cpu_instructions28">28</a> <a href="#cpu_instructions29">29</a> <a href="#cpu_instructions30">30</a> <a href="#cpu_instructions31">31</a> <a href="#cpu_instructions32">32</a> <a href="#cpu_instructions33">33</a> <a href="#cpu_instructions34">34</a> <a href="#cpu_instructions35">35</a> <a href="#cpu_instructions36">36</a> <a href="#cpu_instructions37">37</a> 38)</span> &gt;&gt=
<span class="k">case</span> <span class="mh">0x37</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// scf</span>
    <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">UpdateC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mh">0x3F</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// ccf</span>
    <span class="n">UpdateN</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">UpdateH</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">UpdateC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="o">!</span><span class="n">ReadC</span><span class="p">(</span><span class="n">gb</span><span class="p">));</span>
<span class="p">}</span> <span class="k">break</span><span class="p">;</span>
</code></pre>

<h3 id="undocumented">Undocumented</h3>
<p>The CPU instructions <code>0xD3</code>, <code>0xDB</code>, <code>0xDD</code>, <code>0xE3</code>, <code>0xE4</code>, <code>0xEB</code>, <code>0xEC</code>,
<code>0xED</code>, <code>0xF4</code>, <code>0xFC</code> and <code>0xFD</code> are undocumented, and currently unemulated.</p>
<h1 id="core-initialisation-and-main-loop">Core initialisation and main loop</h1>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state3" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> <a href="#state1">1</a> <a href="#state2">2</a> 3 <a href="#state4">4</a> <a href="#state5">5</a> <a href="#state6">6</a> <a href="#state7">7</a> <a href="#state8">8</a>)</span> &gt;&gt=
<span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">Title</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">bool</span> <span class="n">HasRTC</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">HasBattery</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">HasRumble</span><span class="p">;</span>
<span class="p">}</span> <span class="n">info</span><span class="p">;</span>
</code></pre>

<h2 id="rom-loading">ROM Loading</h2>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="public_function_declarations0" href="#public_function_declarations0">public function declarations</a><span class="chunk-index"> (0 <a href="#public_function_declarations1">1</a> <a href="#public_function_declarations2">2</a> <a href="#public_function_declarations3">3</a> <a href="#public_function_declarations4">4</a>)</span> &gt;&gt=
<span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="nf">gameboy_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading_function0" href="#rom_loading_function0">rom loading function</a> &gt;&gt=
<span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="nf">gameboy_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    &lt;&lt <a href="#rom_loading0">rom loading</a> &gt;&gt;

<span class="cp">#if GAMEBOY_DEBUG</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">Context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">MemoryReadHook</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">MemoryWriteHook</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>When loading a ROM first clear any existing info</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading0" href="#rom_loading0">rom loading</a><span class="chunk-index"> (0 <a href="#rom_loading1">1</a> <a href="#rom_loading2">2</a> <a href="#rom_loading3">3</a> <a href="#rom_loading4">4</a> <a href="#rom_loading5">5</a> <a href="#rom_loading6">6</a> <a href="#rom_loading7">7</a>)</span> &gt;&gt=
<span class="cm">/* Reset state */</span>
<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">Title</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">Title</span><span class="p">));</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRTC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRumble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>The cartridge ROM contains a header from address <code>0x104</code> - <code>0x14F</code>. The <code>0x104</code> - <code>0x133</code> is the Nintendo logo, which is checked by the boot ROM on real Gameboy hardware, as a form of copy protection. </p>
<p>A one-byte checksum of the header is stored at address <code>0x14D</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading1" href="#rom_loading0">rom loading</a><span class="chunk-index"> (<a href="#rom_loading0">0</a> 1 <a href="#rom_loading2">2</a> <a href="#rom_loading3">3</a> <a href="#rom_loading4">4</a> <a href="#rom_loading5">5</a> <a href="#rom_loading6">6</a> <a href="#rom_loading7">7</a>)</span> &gt;&gt=
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">headerChecksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x134</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x14D</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">headerChecksum</span> <span class="o">=</span> <span class="n">headerChecksum</span> <span class="o">-</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">headerChecksum</span> <span class="o">!=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x14D</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Header checksum incorrect&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The name of the ROM is stored (zero-padded) in the header at addresses <code>0x134</code> - <code>0x143</code>. Later ROMs re-purpose the last four characters for a manufacturer code, these bytes always have the high bit set.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading2" href="#rom_loading0">rom loading</a><span class="chunk-index"> (<a href="#rom_loading0">0</a> <a href="#rom_loading1">1</a> 2 <a href="#rom_loading3">3</a> <a href="#rom_loading4">4</a> <a href="#rom_loading5">5</a> <a href="#rom_loading6">6</a> <a href="#rom_loading7">7</a>)</span> &gt;&gt=
<span class="cm">/* Copy ROM title */</span>
<span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x134</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
    <span class="cm">/* High bytes are part of new-style licences */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">Title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The byte at address <code>0x147</code> specifies the cartridge type. This includes the type
of memory bank controller and what external hardware is connected (if any).</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading3" href="#rom_loading0">rom loading</a><span class="chunk-index"> (<a href="#rom_loading0">0</a> <a href="#rom_loading1">1</a> <a href="#rom_loading2">2</a> 3 <a href="#rom_loading4">4</a> <a href="#rom_loading5">5</a> <a href="#rom_loading6">6</a> <a href="#rom_loading7">7</a>)</span> &gt;&gt=
<span class="k">switch</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x147</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x00</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC_None</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x01</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC1_16_8</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x02</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC1_16_8</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x03</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC1_16_8</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x05</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC2</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x06</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC2</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x08</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC_None</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x09</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC_None</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x0F</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC3</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRTC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x10</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC3</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRTC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x11</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC3</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x12</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC3</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x13</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC3</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x19</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC5</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x1A</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC5</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x1B</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC5</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x1C</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC5</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRumble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x1D</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC5</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRumble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x1E</span><span class="o">:</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC5</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasBattery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRumble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x1F</span><span class="o">:</span> <span class="k">return</span> <span class="s">&quot;Pocket Camera not supported&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0xFD</span><span class="o">:</span> <span class="k">return</span> <span class="s">&quot;Bandai TAMA5 not supported&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0xFE</span><span class="o">:</span> <span class="k">return</span> <span class="s">&quot;Hudson HuC-3 not supported&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0xFF</span><span class="o">:</span> <span class="k">return</span> <span class="s">&quot;Hudson HuC-1 not supported&quot;</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x0B</span><span class="o">:</span>
    <span class="k">case</span> <span class="mh">0x0C</span><span class="o">:</span>
    <span class="k">case</span> <span class="mh">0x0D</span><span class="o">:</span>
        <span class="k">return</span> <span class="s">&quot;MMM01 not supported&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="s">&quot;Unknown ROM type&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>The byte at address <code>0x148</code> specifies the size of the ROM in the cartridge.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading4" href="#rom_loading0">rom loading</a><span class="chunk-index"> (<a href="#rom_loading0">0</a> <a href="#rom_loading1">1</a> <a href="#rom_loading2">2</a> <a href="#rom_loading3">3</a> 4 <a href="#rom_loading5">5</a> <a href="#rom_loading6">6</a> <a href="#rom_loading7">7</a>)</span> &gt;&gt=
<span class="k">switch</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x148</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x00</span><span class="o">:</span> <span class="cm">/* 256 Kbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x01</span><span class="o">:</span> <span class="cm">/* 512 Kbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x02</span><span class="o">:</span> <span class="cm">/* 1 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">131072</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x03</span><span class="o">:</span> <span class="cm">/* 2 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">262144</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x04</span><span class="o">:</span> <span class="cm">/* 4 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">524288</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x05</span><span class="o">:</span> <span class="cm">/* 8 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">1048576</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x06</span><span class="o">:</span> <span class="cm">/* 16 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">2097152</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x52</span><span class="o">:</span> <span class="cm">/* 9 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">1179648</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x53</span><span class="o">:</span> <span class="cm">/* 10 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">1310720</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x54</span><span class="o">:</span> <span class="cm">/* 12 Mbit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span> <span class="o">=</span> <span class="mi">1572864</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>The byte at address <code>0x149</code> specifies the size of the RAM in the cartridge (if any).</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading5" href="#rom_loading0">rom loading</a><span class="chunk-index"> (<a href="#rom_loading0">0</a> <a href="#rom_loading1">1</a> <a href="#rom_loading2">2</a> <a href="#rom_loading3">3</a> <a href="#rom_loading4">4</a> 5 <a href="#rom_loading6">6</a> <a href="#rom_loading7">7</a>)</span> &gt;&gt=
<span class="k">switch</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x149</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="cm">/* no RAM */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="cm">/* 16 kBit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="cm">/* 64 kBit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="cm">/* 256 kBit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="cm">/* 1 MBit */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">=</span> <span class="mi">131072</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>There is an exception to the above check for the amount of RAM available: the MBC2 memory bank controller always contains 512x4bits of RAM.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading6" href="#rom_loading0">rom loading</a><span class="chunk-index"> (<a href="#rom_loading0">0</a> <a href="#rom_loading1">1</a> <a href="#rom_loading2">2</a> <a href="#rom_loading3">3</a> <a href="#rom_loading4">4</a> <a href="#rom_loading5">5</a> 6 <a href="#rom_loading7">7</a>)</span> &gt;&gt=
<span class="cm">/* All MBC2 chips contain 512x4bits RAM even though ROM[0x149] == 0 */</span>
<span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>A two-byte checksum of the entire ROM is stored in the final two bytes of the
header (<code>0x14E</code> - <code>0x14F</code>). Now that the size of the ROM is known the checksum
can be checked.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rom_loading7" href="#rom_loading0">rom loading</a><span class="chunk-index"> (<a href="#rom_loading0">0</a> <a href="#rom_loading1">1</a> <a href="#rom_loading2">2</a> <a href="#rom_loading3">3</a> <a href="#rom_loading4">4</a> <a href="#rom_loading5">5</a> <a href="#rom_loading6">6</a> 7)</span> &gt;&gt=
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">romChecksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">romChecksum</span> <span class="o">+=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="cm">/* ROM Checksum does not include the checksum bytes */</span>
    <span class="n">romChecksum</span> <span class="o">-=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x14E</span><span class="p">];</span>
    <span class="n">romChecksum</span> <span class="o">-=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x14F</span><span class="p">];</span>

    <span class="k">if</span><span class="p">((((</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x14E</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8u</span><span class="p">)</span> <span class="o">|</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="mh">0x14F</span><span class="p">])</span> <span class="o">!=</span> <span class="n">romChecksum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;ROM Checksum incorrect&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h2 id="resetting">Resetting</h2>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="public_function_declarations1" href="#public_function_declarations0">public function declarations</a><span class="chunk-index"> (<a href="#public_function_declarations0">0</a> 1 <a href="#public_function_declarations2">2</a> <a href="#public_function_declarations3">3</a> <a href="#public_function_declarations4">4</a>)</span> &gt;&gt=
<span class="kt">int</span> <span class="nf">gameboy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enableBootROM</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset_function0" href="#reset_function0">reset function</a> &gt;&gt=
<span class="kt">int</span> <span class="nf">gameboy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enableBootROM</span><span class="p">)</span>
<span class="p">{</span>
    &lt;&lt <a href="#reset0">reset</a> &gt;&gt;
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>Store whether the boot ROM is enabled</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset2" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> 2 <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">BootROMEnabled</span> <span class="o">=</span> <span class="n">enableBootROM</span><span class="p">;</span>
</code></pre>

<p>If the boot ROM is enabled then execution begins at address zero, and the boot
ROM will do all required initialisation. If it is not then execution should
start at the beginning of the cartridge (<code>0x100</code>).</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset3" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> 3 <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="cm">/* Either start executing the boot ROM or the Cart code. */</span>
<span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">BootROMEnabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">PC</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p>Initialise all CPU registers to known values</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset4" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> 4 <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">SP</span> <span class="o">=</span> <span class="mh">0xFFFE</span><span class="p">;</span>

<span class="c1">// Taken from The Cycle Accurate GB Doc</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">F</span> <span class="o">=</span> <span class="mh">0xB0</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">B</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">C</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">D</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">E</span> <span class="o">=</span> <span class="mh">0xD8</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="mh">0x4D</span><span class="p">;</span>

<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptsEnabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">InterruptEnablePending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">Halted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">.</span><span class="n">HaltBug</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</code></pre>

<p>Clear VRAM</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset5" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> 5 <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="cm">/* Clear all VRAM - the bootrom does this. */</span>
<span class="n">memset</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">));</span>
</code></pre>

<p>Initialise IO registers to known values.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset6" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> 6 <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="cm">/* Initialise required IO registers */</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_Joypad</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xCF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_SerialControl</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7E</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerCounter</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerModulo</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_TimerControl</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDControl</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ScrollY</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ScrollX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDYCompare</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_BackgroundPalette</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ObjectPalette0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ObjectPalette1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_WindowX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_WindowY</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">InterruptEnable</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

<span class="cm">/* Initialise sound IO registers */</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF3</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3F</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF1A</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF1B</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF1C</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9F</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF1E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF22</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF23</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xBF</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF24</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x77</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF25</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF3</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="mh">0xFF26</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF1</span><span class="p">;</span>
</code></pre>

<p>Reset MBC state</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset7" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> 7 <a href="#reset8">8</a> <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMBankEnabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cm">/* MBC1 always starts up in 16/8 mode */</span>
<span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC1_4_32</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC1_16_8</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre>

<p>Reset internal state</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset8" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> 8 <a href="#reset9">9</a> <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">buttons</span><span class="p">.</span><span class="n">Pressed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">NewFrame</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</code></pre>

<h2 id="main-loop">Main loop</h2>
<p>A single function is provided to execute a single CPU instruction and handle all
required updates.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="public_function_declarations2" href="#public_function_declarations0">public function declarations</a><span class="chunk-index"> (<a href="#public_function_declarations0">0</a> <a href="#public_function_declarations1">1</a> 2 <a href="#public_function_declarations3">3</a> <a href="#public_function_declarations4">4</a>)</span> &gt;&gt=
<span class="kt">int</span> <span class="nf">gameboy_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="step_function0" href="#step_function0">step function</a> &gt;&gt=
<span class="kt">int</span> <span class="nf">gameboy_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">input_update</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">cpu_handleInterrupts</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="n">cpu_step</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="gameboy_functions0" href="#gameboy_functions0">gameboy functions</a> &gt;&gt=
&lt;&lt <a href="#rom_loading_function0">rom loading function</a> &gt;&gt;
&lt;&lt <a href="#reset_function0">reset function</a> &gt;&gt;
&lt;&lt <a href="#step_function0">step function</a> &gt;&gt;
</code></pre>

<h1 id="boot-rom">Boot ROM</h1>
<p>When the boot rom is enabled the first 256 bytes of memory are mapped to an
internal ROM. Since CPU execution starts at address zero this ROM is the first
code to be executed on a real Gameboy.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="boot_rom0" href="#boot_rom0">boot rom</a> &gt;&gt=
<span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">BootROM</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x31</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xAF</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0x9F</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0xCB</span><span class="p">,</span><span class="mh">0x7C</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xFB</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x26</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span>
    <span class="mh">0x11</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0xE2</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0xF3</span><span class="p">,</span><span class="mh">0xE2</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0xFC</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span>
    <span class="mh">0x47</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x1A</span><span class="p">,</span><span class="mh">0xCD</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xCD</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0x7B</span><span class="p">,</span>
    <span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x34</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xF3</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0xD8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x1A</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xF9</span><span class="p">,</span>
    <span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mh">0xEA</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x2F</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x3D</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
    <span class="mh">0xF9</span><span class="p">,</span><span class="mh">0x2E</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0xF3</span><span class="p">,</span><span class="mh">0x67</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0x57</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x91</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span>
    <span class="mh">0x1E</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0xF0</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xFA</span><span class="p">,</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xF7</span><span class="p">,</span><span class="mh">0x1D</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xF2</span><span class="p">,</span>
    <span class="mh">0x0E</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0x24</span><span class="p">,</span><span class="mh">0x7C</span><span class="p">,</span><span class="mh">0x1E</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x62</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x1E</span><span class="p">,</span><span class="mh">0xC1</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span>
    <span class="mh">0x7B</span><span class="p">,</span><span class="mh">0xE2</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x87</span><span class="p">,</span><span class="mh">0xE2</span><span class="p">,</span><span class="mh">0xF0</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xD2</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
    <span class="mh">0x4F</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0xCB</span><span class="p">,</span><span class="mh">0x4F</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0xC5</span><span class="p">,</span><span class="mh">0xCB</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="mh">0xC1</span><span class="p">,</span><span class="mh">0xCB</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span>
    <span class="mh">0x05</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xF5</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0xC9</span><span class="p">,</span><span class="mh">0xCE</span><span class="p">,</span><span class="mh">0xED</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0xCC</span><span class="p">,</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0B</span><span class="p">,</span>
    <span class="mh">0x03</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x1F</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span>
    <span class="mh">0xDC</span><span class="p">,</span><span class="mh">0xCC</span><span class="p">,</span><span class="mh">0x6E</span><span class="p">,</span><span class="mh">0xE6</span><span class="p">,</span><span class="mh">0xDD</span><span class="p">,</span><span class="mh">0xDD</span><span class="p">,</span><span class="mh">0xD9</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0xBB</span><span class="p">,</span><span class="mh">0xBB</span><span class="p">,</span><span class="mh">0x67</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0x6E</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0xEC</span><span class="p">,</span><span class="mh">0xCC</span><span class="p">,</span>
    <span class="mh">0xDD</span><span class="p">,</span><span class="mh">0xDC</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x9F</span><span class="p">,</span><span class="mh">0xBB</span><span class="p">,</span><span class="mh">0xB9</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x3C</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0xB9</span><span class="p">,</span><span class="mh">0xA5</span><span class="p">,</span><span class="mh">0xB9</span><span class="p">,</span><span class="mh">0xA5</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x3C</span><span class="p">,</span>
    <span class="mh">0x21</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0xA8</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x1A</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0xBE</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x7D</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x34</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span>
    <span class="mh">0xF5</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0x86</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xFB</span><span class="p">,</span><span class="mh">0x86</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xFE</span><span class="p">,</span><span class="mh">0x3E</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">,</span><span class="mh">0x50</span>
<span class="p">};</span>
</code></pre>

<p><a name="regff50"></a>
A register at address <code>0xFF50</code> is used to disable access to the boot ROM, and
therefore allow the first 256 bytes of the cartridge ROM to be read instead. The
boot ROM cannot be re-enabled once disabled.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_write_special_cases4" href="#mmu_write_special_cases0">mmu write special cases</a><span class="chunk-index"> (<a href="#mmu_write_special_cases0">0</a> <a href="#mmu_write_special_cases1">1</a> <a href="#mmu_write_special_cases2">2</a> <a href="#mmu_write_special_cases3">3</a> 4 <a href="#mmu_write_special_cases5">5</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">IO_BootROMDisable</span><span class="p">:</span> <span class="cm">/* Writing to this address disables the boot ROM */</span>
    <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">BootROMEnabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<h1 id="memory-subsystem-emulation">Memory subsystem emulation</h1>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state4" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> <a href="#state1">1</a> <a href="#state2">2</a> <a href="#state3">3</a> 4 <a href="#state5">5</a> <a href="#state6">6</a> <a href="#state7">7</a> <a href="#state8">8</a>)</span> &gt;&gt=
<span class="k">struct</span> <span class="p">{</span>
    <span class="cm">/* 0x8000 - 0x9FFF */</span>
    <span class="kt">uint8_t</span> <span class="n">VideoRAM</span><span class="p">[</span><span class="mi">8192</span><span class="p">];</span>
    <span class="cm">/* 0xC000 - 0xDFFF */</span>
    <span class="kt">uint8_t</span> <span class="n">WorkRAM</span><span class="p">[</span><span class="mi">8192</span><span class="p">];</span>
    <span class="cm">/* 0xFE00 - 0xFE9F */</span>
    <span class="kt">uint8_t</span> <span class="n">OAM</span><span class="p">[</span><span class="mi">160</span><span class="p">];</span>
    <span class="cm">/* 0xFF00 - 0xFF7F */</span>
    <span class="kt">uint8_t</span> <span class="n">IO</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
    <span class="cm">/* 0xFF80 - 0xFFFE */</span>
    <span class="kt">uint8_t</span> <span class="n">HighRAM</span><span class="p">[</span><span class="mi">127</span><span class="p">];</span>
    <span class="cm">/* 0xFFFF */</span>
    <span class="kt">uint8_t</span> <span class="n">InterruptEnable</span><span class="p">;</span>

    <span class="cm">/* The cartridge ROM &amp; RAM is typically banked into the main address</span>
<span class="cm">     * space using a MBC chip */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CartROMSize</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">CartROM</span><span class="p">[</span><span class="n">Cart_MaxROMSize</span><span class="p">];</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CartRAMSize</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">CartRAM</span><span class="p">[</span><span class="n">Cart_MaxRAMSize</span><span class="p">];</span>

    <span class="cm">/* If true then addresses 00-FF contain the boot ROM */</span>
    <span class="kt">bool</span> <span class="n">BootROMEnabled</span><span class="p">;</span>

    <span class="cm">/* Cartridge RAM should be enabled before writing to it, and disabled when finished */</span>
    <span class="kt">bool</span> <span class="n">CartRAMBankEnabled</span><span class="p">;</span>

    <span class="cm">/* Model and state of the MBC chip */</span>
    <span class="kt">int</span> <span class="n">MBCModel</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MBCROMBank</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MBCRAMBank</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mem</span><span class="p">;</span>
</code></pre>

<p>All systems access memory via two functions:</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="function_declarations1" href="#function_declarations0">function declarations</a><span class="chunk-index"> (<a href="#function_declarations0">0</a> 1 <a href="#function_declarations2">2</a> <a href="#function_declarations3">3</a> <a href="#function_declarations4">4</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">mmu_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="p">);</span>
</code></pre>

<p>The memory map of the Gameboy is quite straight forward</p>
<ul>
<li><code>0x0000</code> - <code>0x0100</code> Boot ROM (when enabled)</li>
<li><code>0x0000</code> - <code>0x3FFF</code> (16K) Cartridge ROM bank 0</li>
<li><code>0x4000</code> - <code>0x7FFF</code> (16K) Cartridge banked ROM area</li>
<li><code>0x8000</code> - <code>0x9FFF</code> (8K) VRAM</li>
<li><code>0xA000</code> - <code>0xBFFF</code> (8K) Cartridge banked RAM</li>
<li><code>0xC000</code> - <code>0xDFFF</code> (8K) Internal (work) RAM</li>
<li><code>0xE000</code> - <code>0xFDFF</code> (~8K) Mirror of internal RAM</li>
<li><code>0xFE00</code> - <code>0xFE9F</code> Sprite attributes (OAM)</li>
<li><code>0xFF00</code> - <code>0xFF7F</code> IO registers</li>
<li><code>0xFF80</code> - <code>0xFFFE</code> High RAM, usable during DMA</li>
<li><code>0xFFFF</code> - Interrupt enable register</li>
</ul>
<p>Physically there are two 8 Kilobyte SRAM chips (video and work RAM). The video
RAM is connected to a separate address and data bus from the work RAM (which
shares its busses with the cartridge slot). This allows the video processor to
access the video RAM in parallel to the main CPU accessing either the cartridge
or work RAM.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_read_direct0" href="#mmu_read_direct0">mmu read direct</a> &gt;&gt=
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">mmu_readDirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;=</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">BootROMEnabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">BootROM</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* 16K - ROM Bank #0 (fixed) */</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* 16K - Banked ROM area */</span>
        <span class="k">return</span> <span class="n">mmu_readBankedROM</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span> <span class="o">-</span> <span class="mh">0x4000</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xA000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Video RAM */</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x8000</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* 8K - Banked RAM Area */</span>
        <span class="k">return</span> <span class="n">mmu_readBankedRAM</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span> <span class="o">-</span> <span class="mh">0xA000</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* 8K - Internal RAM */</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">WorkRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xC000</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFE00</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Mirror of internal RAM */</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">WorkRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xE000</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFE9F</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* OAM */</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">OAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFE00</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Empty */</span>
        <span class="k">return</span> <span class="mh">0x00</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFF80</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* IO registers */</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFF00</span><span class="p">]</span> <span class="o">|</span> <span class="n">IOUnusedBits</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFF00</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">HighRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFF80</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">InterruptEnable</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="io_register_addresses0" href="#io_register_addresses0">io register addresses</a> &gt;&gt=
<span class="k">enum</span> <span class="n">IORegisters</span> <span class="p">{</span>
    <span class="cm">/* Addresses relative to 0xFF00 */</span>
    <span class="n">IO_Joypad</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="n">IO_SerialData</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
    <span class="n">IO_SerialControl</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
    <span class="n">IO_Divider</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
    <span class="n">IO_TimerCounter</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
    <span class="n">IO_TimerModulo</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
    <span class="n">IO_TimerControl</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
    <span class="n">IO_InterruptFlag</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">,</span>

    <span class="n">IO_Sound1Sweep</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
    <span class="n">IO_Sound1Mode</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
    <span class="n">IO_Sound1Envelope</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
    <span class="n">IO_Sound1FreqLo</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>
    <span class="n">IO_Sound1FreqHi</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>

    <span class="n">IO_Sound2Mode</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">,</span>
    <span class="n">IO_Sound2Envelope</span> <span class="o">=</span> <span class="mh">0x17</span><span class="p">,</span>
    <span class="n">IO_Sound2FreqLo</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
    <span class="n">IO_Sound2FreqHi</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">,</span>

    <span class="n">IO_Sound3Enable</span> <span class="o">=</span> <span class="mh">0x1A</span><span class="p">,</span>
    <span class="n">IO_Sound3Length</span> <span class="o">=</span> <span class="mh">0x1B</span><span class="p">,</span>
    <span class="n">IO_Sound3Level</span> <span class="o">=</span> <span class="mh">0x1C</span><span class="p">,</span>
    <span class="n">IO_Sound3FreqLo</span> <span class="o">=</span> <span class="mh">0x1D</span><span class="p">,</span>
    <span class="n">IO_Sound3FreqHi</span> <span class="o">=</span> <span class="mh">0x1E</span><span class="p">,</span>

    <span class="n">IO_Sound4Length</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
    <span class="n">IO_Sound4Envelope</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">,</span>
    <span class="n">IO_Sound4Poly</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>
    <span class="n">IO_Sound4Counter</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">,</span>

    <span class="n">IO_SoundChannels</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>
    <span class="n">IO_SoundOutput</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">,</span>
    <span class="n">IO_SoundControl</span> <span class="o">=</span> <span class="mh">0x26</span><span class="p">,</span>

    <span class="cm">/* 0x30 - 0x3F wave RAM */</span>

    <span class="n">IO_LCDControl</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
    <span class="n">IO_LCDStat</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">,</span>
    <span class="n">IO_ScrollY</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">,</span>
    <span class="n">IO_ScrollX</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">,</span>
    <span class="n">IO_LCDY</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>
    <span class="n">IO_LCDYCompare</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">,</span>
    <span class="n">IO_OAMDMA</span> <span class="o">=</span> <span class="mh">0x46</span><span class="p">,</span>
    <span class="n">IO_BackgroundPalette</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">,</span>
    <span class="n">IO_ObjectPalette0</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>
    <span class="n">IO_ObjectPalette1</span> <span class="o">=</span> <span class="mh">0x49</span><span class="p">,</span>
    <span class="n">IO_WindowY</span> <span class="o">=</span> <span class="mh">0x4A</span><span class="p">,</span>
    <span class="n">IO_WindowX</span> <span class="o">=</span> <span class="mh">0x4B</span><span class="p">,</span>

    <span class="n">IO_BootROMDisable</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
<span class="p">};</span>
</code></pre>

<p>Some IO Registers have unused bits which always read 1s.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="io_registers_unused_bits0" href="#io_registers_unused_bits0">io registers unused bits</a> &gt;&gt=
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">IOUnusedBits</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">IO_Joypad</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>
    <span class="c1">// ... </span>
<span class="p">};</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="memory_functions0" href="#memory_functions0">memory functions</a> &gt;&gt=
&lt;&lt <a href="#boot_rom0">boot rom</a> &gt;&gt;
&lt;&lt <a href="#rtc_functions0">rtc functions</a> &gt;&gt;
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">mmu_readBankedROM</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relativeAddress</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cartAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">*</span> <span class="mi">16384</span><span class="p">)</span> <span class="o">+</span> <span class="n">relativeAddress</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROM</span><span class="p">[</span><span class="n">cartAddr</span> <span class="o">%</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartROMSize</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">mmu_readBankedRAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relativeAddress</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC3</span> <span class="o">&amp;&amp;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">&gt;=</span> <span class="n">Cart_MBC3_RTCBase</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">mmu_readRTC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cartAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">*</span> <span class="mi">8192</span><span class="p">)</span> <span class="o">+</span> <span class="n">relativeAddress</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span> <span class="o">&amp;&amp;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMBankEnabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAM</span><span class="p">[</span><span class="n">cartAddr</span> <span class="o">%</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
&lt;&lt <a href="#mmu_read_direct0">mmu read direct</a> &gt;&gt;

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_writeBankedRAM</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relativeAddress</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC3</span> <span class="o">&amp;&amp;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">&gt;=</span> <span class="n">Cart_MBC3_RTCBase</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mmu_writeRTC</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMBankEnabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cartAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">*</span> <span class="mi">8192</span><span class="p">)</span> <span class="o">+</span> <span class="n">relativeAddress</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cartAddr</span> <span class="o">&lt;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMSize</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC2</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// MBC2 internal RAM is 4bit</span>
                <span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAM</span><span class="p">[</span><span class="n">cartAddr</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_setROMBank</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span><span class="p">)</span> <span class="p">{</span>
        &lt;&lt <a href="#set_rom_bank_cases0">set rom bank cases</a> &gt;&gt;

        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_setRAMBank</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span><span class="p">)</span> <span class="p">{</span>
        &lt;&lt <a href="#set_ram_bank_cases0">set ram bank cases</a> &gt;&gt;

        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">mmu_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">GBTRACE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameboy_tp</span><span class="p">){</span> <span class="p">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">GAMEBOY_TP_MEM_READ</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">mem_read</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}));</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Active</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFF80</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* When OAM DMA is in progress any memory accesses outside of</span>
<span class="cm">         * high RAM (0xFF80 - 0xFFFE) will return 0xFF */</span>
        <span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">mmu_readDirect</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_writeDirect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Cart RAM enable */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">CartRAMBankEnabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xA</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* ROM Bank select */</span>
        <span class="n">mmu_setROMBank</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x6000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* RAM Bank select (or high bits of ROM Bank for MBC1 mode 16/8) */</span>
        <span class="n">mmu_setRAMBank</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* MBC1 Mode selection or MBC3 RTC latching */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC1_16_8</span> <span class="o">||</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC1_4_32</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//&lt;&lt; mbc1 model selection &gt;&gt;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">==</span> <span class="n">Cart_MBC3</span><span class="p">)</span> <span class="p">{</span>
            &lt;&lt <a href="#rtc_latching0">rtc latching</a> &gt;&gt;
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xA000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Video RAM */</span>
        <span class="c1">// TODO: Writes to VRAM should be ignored when the LCD is being redrawn</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0x8000</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xC000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Banked RAM Area */</span>
        <span class="n">mmu_writeBankedRAM</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span> <span class="o">-</span> <span class="mh">0xA000</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Internal RAM */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">WorkRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xC000</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFE00</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Mirror of internal RAM */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">WorkRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xE000</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFE9F</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* OAM */</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">OAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFE00</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Empty */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFF80</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* IO registers */</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="p">{</span>
            &lt;&lt <a href="#mmu_write_special_cases0">mmu write special cases</a> &gt;&gt;
            <span class="k">case</span> <span class="nl">IO_LCDStat</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="kt">uint8_t</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">];</span>
                    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="nl">IO_LCDY</span><span class="p">:</span> <span class="cm">/* Current scanline -&gt; writing resets it to zero */</span>
                <span class="p">{</span>
                    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">default</span><span class="o">:</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFF00</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">HighRAM</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="mh">0xFF80</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">InterruptEnable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">GBTRACE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameboy_tp</span><span class="p">){</span> <span class="p">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">GAMEBOY_TP_MEM_WRITE</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">mem_write</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">,</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}));</span>
    <span class="n">clock_increment</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>

    <span class="cm">/* TODO is access to IO space (0xFF00 - 0xFF7F) OK? */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Active</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* When OAM DMA is in progress any memory writes outside of</span>
<span class="cm">         * high RAM (0xFF80 - 0xFFFE) will be ignored */</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">mmu_writeDirect</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">uint8_t</span> <span class="nf">gameboy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">mmu_readDirect</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gameboy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mmu_writeDirect</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="public_function_declarations3" href="#public_function_declarations0">public function declarations</a><span class="chunk-index"> (<a href="#public_function_declarations0">0</a> <a href="#public_function_declarations1">1</a> <a href="#public_function_declarations2">2</a> 3 <a href="#public_function_declarations4">4</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="nf">gameboy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">gameboy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">);</span>
</code></pre>

<h1 id="memory-banking"><a name="memory-banking"></a>Memory Banking</h1>
<p>Most Gameboy cardridges contain more ROM than the 32KiB of available address
space, and many include more RAM than the 8KiB of available address space for
it. Therefore these cartridges contain a chip called a Memory Bank Controller
(MBC). There are several different MBCs with various features. They are all
controlled by writes to the ROM address space.</p>
<p>The models supported by the emulator are MBC1, MBC2, MBC3 and MBC5. All models
bank the ROM in 16KiB pages and the RAM in 8KiB pages. This matches the ranges
shown in the memory map.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_enum0" href="#mmu_enum0">mmu enum</a> &gt;&gt=
<span class="k">enum</span> <span class="p">{</span>
    <span class="n">Cart_MaxROMSize</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">Cart_MaxRAMSize</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>

    <span class="n">Cart_MBC_None</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

    <span class="cm">/* MBC1 can operate in two modes, switchable at runtime */</span>
    <span class="n">Cart_MBC1_16_8</span><span class="p">,</span>
    <span class="n">Cart_MBC1_4_32</span><span class="p">,</span>

    <span class="n">Cart_MBC2</span><span class="p">,</span>
    <span class="n">Cart_MBC3</span><span class="p">,</span>
    <span class="n">Cart_MBC5</span><span class="p">,</span>

    <span class="n">Cart_MBC3_RTCBase</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
    <span class="n">Cart_MBC3_RTCLast</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">,</span>
<span class="p">};</span>
</code></pre>

<h2 id="mbc1">MBC1</h2>
<p>Supports two modes, switchable at runtime: 32KiB banked RAM with 4MiB banked
ROM, or 8KiB unbanked RAM with 16MiB banked ROM. This is implemented using two
registers</p>
<ul>
<li>A 5-bit register which always provides the bottom 5-bits of the ROM bank. if zero is written to this register then it is actually set to one, which prevents ROM banks <code>0x00</code>, <code>0x20</code>, <code>0x40</code> and <code>0x60</code> ever being mapped</li>
<li>A 2-bit register which either selects the RAM bank or provides the top 2-bits of the ROM bank</li>
</ul>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="set_rom_bank_cases0" href="#set_rom_bank_cases0">set rom bank cases</a><span class="chunk-index"> (0 <a href="#set_rom_bank_cases1">1</a> <a href="#set_rom_bank_cases2">2</a> <a href="#set_rom_bank_cases3">3</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">Cart_MBC1_16_8</span><span class="p">:</span>
<span class="k">case</span> <span class="nl">Cart_MBC1_4_32</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="cm">/* Bottom 5 bits of ROM Bank number */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bankNo</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
        <span class="cm">/* Zero in this register always maps to 1 */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">bankNo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bankNo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">|</span> <span class="n">bankNo</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="set_ram_bank_cases0" href="#set_ram_bank_cases0">set ram bank cases</a><span class="chunk-index"> (0 <a href="#set_ram_bank_cases1">1</a> <a href="#set_ram_bank_cases2">2</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">Cart_MBC1_16_8</span><span class="p">:</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5u</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="nl">Cart_MBC1_4_32</span><span class="p">:</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>When switching modes the registers maintain their values.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mbc1_mode_selection0" href="#mbc1_mode_selection0">mbc1 mode selection</a> &gt;&gt=
<span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1u</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// RAM Banking mode - 32Kbyte RAM in 4 banks, 4MBit ROM</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC1_4_32</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">&gt;&gt;</span> <span class="mi">5u</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="c1">// ROM Banking mode - 8Kbytes unbanked RAM, 16MBit ROM</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCModel</span> <span class="o">=</span> <span class="n">Cart_MBC1_16_8</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5u</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<h2 id="mbc2">MBC2</h2>
<p>All MBC2 chips contain 512 cells of 4bit RAM, which is exposed as 512 bytes in
the mapped RAM area. The top 4 bits of each of these bytes does not store data
written to it. Supports up to 16 ROM banks (4 Megabit ROM). Writing zero to the
ROM bank register actually sets it to one, preventing bank zero being mapped to
the banked ROM area.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="set_rom_bank_cases1" href="#set_rom_bank_cases0">set rom bank cases</a><span class="chunk-index"> (<a href="#set_rom_bank_cases0">0</a> 1 <a href="#set_rom_bank_cases2">2</a> <a href="#set_rom_bank_cases3">3</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">Cart_MBC2</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bankNo</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="n">bankNo</span><span class="o">?</span> <span class="nl">bankNo</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<h2 id="mbc3">MBC3</h2>
<p>Supports up to 128 ROM banks (16 Megabit ROM) and 4 RAM banks. Writing zero to
the ROM bank register will actually set it to one. The MBC3 also has support for
a real time clock.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="set_rom_bank_cases2" href="#set_rom_bank_cases0">set rom bank cases</a><span class="chunk-index"> (<a href="#set_rom_bank_cases0">0</a> <a href="#set_rom_bank_cases1">1</a> 2 <a href="#set_rom_bank_cases3">3</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">Cart_MBC3</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bankNo</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="n">bankNo</span><span class="o">?</span> <span class="nl">bankNo</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="set_ram_bank_cases1" href="#set_ram_bank_cases0">set ram bank cases</a><span class="chunk-index"> (<a href="#set_ram_bank_cases0">0</a> 1 <a href="#set_ram_bank_cases2">2</a>)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">Cart_MBC3</span><span class="p">:</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<h3 id="mbc3-real-time-clock-rtc">MBC3 Real Time Clock (RTC)</h3>
<p>The RTC provides 5 registers, which are selected by writing a specific RAM bank number:</p>
<table>
<thead>
<tr>
<th>RAM Bank</th>
<th>Register</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x08</td>
<td>Seconds (0-59)</td>
</tr>
<tr>
<td>0x09</td>
<td>Minutes (0-59)</td>
</tr>
<tr>
<td>0x0A</td>
<td>Hours (0-23)</td>
</tr>
<tr>
<td>0x0B</td>
<td>Days (lower 8 bits, 0-255)</td>
</tr>
<tr>
<td>0x0C (bit 0)</td>
<td>Upper bit of day counter</td>
</tr>
<tr>
<td>0x0C (bit 6)</td>
<td>Halt flag (1 = stop timer)</td>
</tr>
<tr>
<td>0x0C (bit 7)</td>
<td>Overflow flag, set when 9-bit day counter overflows. Remains set until explicitly cleared.</td>
</tr>
</tbody>
</table>
<p>These registers cannot be directly read, there is another set of registers into
which the underlying register values are copied (latched) when requested. This
provides a consistent view of all the underlying registers as the latched values
will only update all together when explicitly requested. When writing to RTC
registers the underlying registers are written directly, and so the clock should
be stopped before performing any writes.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state5" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> <a href="#state1">1</a> <a href="#state2">2</a> <a href="#state3">3</a> <a href="#state4">4</a> 5 <a href="#state6">6</a> <a href="#state7">7</a> <a href="#state8">8</a>)</span> &gt;&gt=
<span class="k">struct</span> <span class="p">{</span>
    <span class="kt">time_t</span> <span class="n">BaseTime</span><span class="p">;</span>

    <span class="cm">/* seconds, minutes, hours, days, dayhi */</span>
    <span class="kt">uint8_t</span> <span class="n">BaseReg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="n">LatchedReg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">bool</span> <span class="n">Latched</span><span class="p">;</span>
<span class="p">}</span> <span class="n">rtc</span><span class="p">;</span>
</code></pre>

<p>To keep track of real time the emulator stores the time provided by the
computer's clock (the base time) along with the calculated values of the RTC
registers. Then to calculate a new set of RTC register values the difference
between the base time and the current time is added on to the stored values of
the RTC registers (unless the RTC is stopped), and the base time updated.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rtc_functions0" href="#rtc_functions0">rtc functions</a> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_updateRTC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">time_t</span> <span class="n">new_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseTime</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">new_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseTime</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">new_time</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">new_time</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">new_time</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">new_time</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">;</span>
    <span class="n">new_time</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>

    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_time</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">new_time</span> <span class="o">/=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_time</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">new_time</span> <span class="o">/=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">;</span>
    <span class="n">new_time</span> <span class="o">/=</span> <span class="mi">24</span><span class="p">;</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_time</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">new_time</span> <span class="o">/=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="cm">/* Top bit of 9-bit day counter */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">new_time</span> <span class="o">%</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">new_time</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="cm">/* Days overflow bit (sticky) */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">new_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseTime</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">mmu_readRTC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x0C</span> <span class="o">||</span> <span class="o">!</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">HasRTC</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">Latched</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">LatchedReg</span><span class="p">[</span><span class="n">reg</span> <span class="o">-</span> <span class="mh">0x08</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">mmu_updateRTC</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="n">reg</span> <span class="o">-</span> <span class="mh">0x08</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmu_writeRTC</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mmu_updateRTC</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="n">reg</span> <span class="o">-</span> <span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="rtc_latching0" href="#rtc_latching0">rtc latching</a> &gt;&gt=
<span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">Latched</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">Latched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">Latched</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mmu_updateRTC</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">LatchedReg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">BaseReg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">rtc</span><span class="p">.</span><span class="n">Latched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<h2 id="mbc5">MBC5</h2>
<p>Supports up to 512 ROM banks (64 Megabit ROM) and 16 RAM pages. The address
range used to write the ROM bank is split in two to provide two registers, which
together form the 9-bit ROM bank number. Unlike the other MBCs it is possible to
map bank 0.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="set_rom_bank_cases3" href="#set_rom_bank_cases0">set rom bank cases</a><span class="chunk-index"> (<a href="#set_rom_bank_cases0">0</a> <a href="#set_rom_bank_cases1">1</a> <a href="#set_rom_bank_cases2">2</a> 3)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">Cart_MBC5</span><span class="p">:</span>
    <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">=</span> <span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCROMBank</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">1u</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9u</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>There is a single 4-bit register for the RAM bank number. If the cartridge has a
rumble motor then bit 4 of this register controls whether it is active.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="set_ram_bank_cases2" href="#set_ram_bank_cases0">set ram bank cases</a><span class="chunk-index"> (<a href="#set_ram_bank_cases0">0</a> <a href="#set_ram_bank_cases1">1</a> 2)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">Cart_MBC5</span><span class="p">:</span>
    <span class="cm">/* TODO Rumble is controlled by bit 4 */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">MBCRAMBank</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<h1 id="oam-dma-0xff46"><a name="regff46"></a>OAM DMA (<code>0xFF46</code>)</h1>
<p>The Gameboy supports simple DMA transfer of a 160-byte block of memory from
256-byte aligned addresses below <code>0xF100</code> into the OAM area. This is used to
update the OAM during the LCD VSync period, as this is the only safe time to
access the OAM. Whilst the DMA engine is transferring data only the high RAM
(<code>0xFF80</code> - <code>0xFFFE</code>) is accessable - all other memory accesses return <code>0xFF</code>.</p>
<p>DMA is initiated by writing to the DMA register at address <code>0xFF46</code> the top 8
bits of the source address for the transfer. The DMA will start after a delay of
1 machine cycle:</p>
<pre><code>ld $a, 0x80
ld (0xFF00 + 0x46), $a
nop ; DMA not started - low memory still accessable
nop ; DMA is now running - low memory reads return 0xFF
</code></pre>
<p>If a DMA operation is in progress then it will continue as normal for the delay
cycle, and then the DMA will restart with the new source address:</p>
<pre><code>; assume a DMA is running
ld $a, 0x80
ld (0xFF00 + 0x46), $a
nop ; Old DMA still running - low memory reads return 0xFF
nop ; New DMA is now running - low memory reads return 0xFF
</code></pre>
<p>Each cycle is executed instantaneously prior to memory reads/writes, so a
separate flag is maintained to indicate to the memory subsystem if a DMA is
active (and low memory accesses are blocked).</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state6" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> <a href="#state1">1</a> <a href="#state2">2</a> <a href="#state3">3</a> <a href="#state4">4</a> <a href="#state5">5</a> 6 <a href="#state7">7</a> <a href="#state8">8</a>)</span> &gt;&gt=
<span class="k">struct</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">DelayStart</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">PendingSource</span><span class="p">;</span>

    <span class="cm">/* Source for currently running DMA (0 if not active) */</span>
    <span class="kt">uint16_t</span> <span class="n">Source</span><span class="p">;</span>

    <span class="cm">/* If OAM DMA is active on current cycle */</span>
    <span class="kt">bool</span> <span class="n">Active</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dma</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset9" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> 9 <a href="#reset10">10</a>)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">PendingSource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">DelayStart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="mmu_write_special_cases5" href="#mmu_write_special_cases0">mmu write special cases</a><span class="chunk-index"> (<a href="#mmu_write_special_cases0">0</a> <a href="#mmu_write_special_cases1">1</a> <a href="#mmu_write_special_cases2">2</a> <a href="#mmu_write_special_cases3">3</a> <a href="#mmu_write_special_cases4">4</a> 5)</span> &gt;&gt=
<span class="k">case</span> <span class="nl">IO_OAMDMA</span><span class="p">:</span> <span class="cm">/* LCD OAM DMA transfer */</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mh">0xF1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">GBTRACE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameboy_tp</span><span class="p">){</span> <span class="p">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">GAMEBOY_TP_DMA_INIT</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}));</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">PendingSource</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">DelayStart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">assert</span><span class="p">(</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Invalid LCD OAM transfer range&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre>

<p>The DMA runs in parallel to CPU execution, transferring a single byte each machine cycle.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="function_declarations2" href="#function_declarations0">function declarations</a><span class="chunk-index"> (<a href="#function_declarations0">0</a> <a href="#function_declarations1">1</a> 2 <a href="#function_declarations3">3</a> <a href="#function_declarations4">4</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="per_machine_cycle_updates3" href="#per_machine_cycle_updates0">per machine cycle updates</a><span class="chunk-index"> (<a href="#per_machine_cycle_updates0">0</a> <a href="#per_machine_cycle_updates1">1</a> <a href="#per_machine_cycle_updates2">2</a> 3 <a href="#per_machine_cycle_updates4">4</a>)</span> &gt;&gt=
<span class="n">dma_update</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="dma_update0" href="#dma_update0">dma update</a> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">PendingSource</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">DelayStart</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">GBTRACE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameboy_tp</span><span class="p">){</span> <span class="p">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">GAMEBOY_TP_DMA_START</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">PendingSource</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}));</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">PendingSource</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">PendingSource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">DelayStart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GBTRACE</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameboy_tp</span><span class="p">){</span> <span class="p">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">GAMEBOY_TP_DMA</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span><span class="p">,</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}));</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">OAM</span><span class="p">[</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmu_readDirect</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span><span class="p">);</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Source</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">Active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h1 id="video-emulation">Video emulation</h1>
<p>The graphical output of the gameboy is displayed on a 160x144 pixel LCD with two
bit colour. Pixel value 3 is the darkest and 0 is the lightest. All graphics are
based on 8x8 pixel tiles which are stored in VRAM.</p>
<p>Each 8x8 pixel tile is made up of 16 bytes (2 bits per pixel x 8 x 8), stored in
memory as 2 bytes per line. Within those two bytes the first byte contains the
least-significant bit of the colour and the second byte the most significant
bit. The left-most (smallest x coordinate) pixel data is stored in the
most-significant bit of the bytes.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="video_helpers0" href="#video_helpers0">video helpers</a><span class="chunk-index"> (0 <a href="#video_helpers1">1</a> <a href="#video_helpers2">2</a> <a href="#video_helpers3">3</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">video_linePixel</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="k">const</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(((</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>The tiles are stored at addresses <code>0x8000</code> to <code>0x9800</code>, which is space for 384
tiles, this is split into two overlapping banks of 256 tiles: <code>0x8000</code> to
<code>0x9000</code> and <code>0x8800</code> to <code>0x9800</code>.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="video_helpers1" href="#video_helpers0">video helpers</a><span class="chunk-index"> (<a href="#video_helpers0">0</a> 1 <a href="#video_helpers2">2</a> <a href="#video_helpers3">3</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">video_tileLineAddress</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">y</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">lowBank</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* These addresses are relative to VRAM base address (0x8000) */</span>
    <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">lowBank</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x1000</span> <span class="o">+</span> <span class="p">((</span><span class="kt">int8_t</span><span class="p">)</span><span class="n">index</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>There are two tile maps of 32x32 tiles (256x256 pixels) each in VRAM at
addresses <code>0x9800</code> (low) and <code>0x9C00</code> (high). Each byte in the map is the index
of an 8x8 tile in one of two tile banks. When addressing the lower tile bank the
index is an unsigned index in the range 0 - 255. When addressing the upper tile
bank the index is a signed integer in the range -128 to 127.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="video_helpers2" href="#video_helpers0">video helpers</a><span class="chunk-index"> (<a href="#video_helpers0">0</a> <a href="#video_helpers1">1</a> 2 <a href="#video_helpers3">3</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">video_mapPixel</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">hiMap</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">loTiles</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">tileIndex</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">[(</span><span class="n">hiMap</span><span class="o">?</span> <span class="mh">0x1C00</span> <span class="o">:</span> <span class="mh">0x1800</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)];</span>
    <span class="kt">uint16_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">video_tileLineAddress</span><span class="p">(</span><span class="n">tileIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">%</span> <span class="mi">8</span><span class="p">),</span> <span class="n">loTiles</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">video_linePixel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">[</span><span class="n">addr</span><span class="p">],</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state7" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> <a href="#state1">1</a> <a href="#state2">2</a> <a href="#state3">3</a> <a href="#state4">4</a> <a href="#state5">5</a> <a href="#state6">6</a> 7 <a href="#state8">8</a>)</span> &gt;&gt=
<span class="k">struct</span> <span class="p">{</span>
    <span class="cm">/* Machine cycles through current frame */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FrameProgress</span><span class="p">;</span>

    <span class="cm">/* Bits 0-1 = colour (0 = darkest, 3 = lightest)</span>
<span class="cm">     * Other bits currently all zero.</span>
<span class="cm">     */</span>
    <span class="kt">uint8_t</span> <span class="n">Buffer</span><span class="p">[</span><span class="mi">160</span><span class="p">][</span><span class="mi">144</span><span class="p">];</span>
    <span class="cm">/* Set to true whenever a complete new frame is available */</span>
    <span class="cm">/* Reset this when you read the frame */</span>
    <span class="kt">bool</span> <span class="n">NewFrame</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">GameboySprite</span> <span class="p">{</span>
        <span class="kt">uint8_t</span> <span class="n">x</span><span class="p">;</span>
        <span class="kt">uint8_t</span> <span class="n">pixels</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="kt">uint8_t</span> <span class="n">attrs</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">ScanlineSprites</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">NumSprites</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CurX</span><span class="p">;</span>
<span class="p">}</span> <span class="n">lcd</span><span class="p">;</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="reset10" href="#reset0">reset</a><span class="chunk-index"> (<a href="#reset0">0</a> <a href="#reset1">1</a> <a href="#reset2">2</a> <a href="#reset3">3</a> <a href="#reset4">4</a> <a href="#reset5">5</a> <a href="#reset6">6</a> <a href="#reset7">7</a> <a href="#reset8">8</a> <a href="#reset9">9</a> 10)</span> &gt;&gt=
<span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">FrameProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre>

<h2 id="palettes-0xff47-0xff49">Palettes (<code>0xFF47</code> - <code>0xFF49</code>)</h2>
<p>There are three palettes, which map from the two-bit input colour from the tile
pixel to the two-bit output colour which will be displayed on the LCD. These
palettes are each stored in a single byte; bits 0-1 are the output colour for
sprite colour 0, bits 2-3 are the output colour for sprite colour 1, bits 4-5
are the output colour for sprite colour 2, and bits 6-7 for sprite colour 3.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="video_helpers3" href="#video_helpers0">video helpers</a><span class="chunk-index"> (<a href="#video_helpers0">0</a> <a href="#video_helpers1">1</a> <a href="#video_helpers2">2</a> 3)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="nf">video_paletteLookup</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">pixel</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">palette</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">pixel</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">palette</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">pixel</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p><a name="regff47"></a>
There is a single palette for the background tiles at address <code>0xFF47</code>.</p>
<p><a name="regff48"></a><a name="regff49"></a>
There are two object palettes (at <code>0xFF48</code>, <code>0xFF49</code>), which can be selected
per-object based on a bit in the object's attributes.</p>
<h2 id="video-control-registers">Video control registers</h2>
<p><a name="regff40"></a></p>
<h2 id="lcd-control-0xff40">LCD Control (<code>0xFF40</code>)</h2>
<table>
<thead>
<tr>
<th>Bits (LSB=0)</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Background &amp; Window enable</td>
</tr>
<tr>
<td>1</td>
<td>Object enable</td>
</tr>
<tr>
<td>2</td>
<td>Object size (0=8x8, 1=8x16)</td>
</tr>
<tr>
<td>3</td>
<td>Background tile map select (0=low, 1=high)</td>
</tr>
<tr>
<td>4</td>
<td>Background &amp; Window tile bank select (0=high, 1=low)</td>
</tr>
<tr>
<td>5</td>
<td>Window enable</td>
</tr>
<tr>
<td>6</td>
<td>Window tile map select (0=low, 1=high)</td>
</tr>
<tr>
<td>7</td>
<td>LCD Enable</td>
</tr>
</tbody>
</table>
<p>The LCD enable must only be set to 0 during VBlank!</p>
<p><a name="regff41"></a></p>
<h2 id="lcd-status-0xff41">LCD Status (<code>0xFF41</code>)</h2>
<p><a name="regff44"></a><a name="regff45"></a></p>
<h2 id="lcd-y-y-compare-0xff44-0xff45">LCD Y &amp; Y Compare (<code>0xFF44</code> &amp; <code>0xFF45</code>)</h2>
<h2 id="background">Background</h2>
<p><a name="regff42"></a><a name="regff43"></a>
The background can be scrolled with pixel precision using the Scroll X and
Scroll Y registers (<code>0xFF42</code> &amp; <code>0xFF43</code>). These registers define the pixel
coordinate in the 256x256 tile mapped background which will be displayed in the
top left of the screen.</p>
<h2 id="window">Window</h2>
<p><a name="regff4a"></a><a name="regff4b"></a>
Unlike the background the window cannot be scrolled. The Window X and Window Y
registers (<code>0xFF4A</code> &amp; <code>0xFF4B</code>) define the screen pixel coordinate at which the
top left of the window tilemap is drawn.</p>
<h2 id="objects-sprites">Objects (Sprites)</h2>
<p>Objects/sprites are made up of one or two tiles (8x8 or 8x16 pixels, selected in
the LCD Control register) positioned at exact pixel coordinates. Up to 40
objects can be specified in the Object Attribute Memory (OAM), at addresses
<code>0xFE00</code> - <code>0xFE9F</code>. Each object definition is 4 bytes, consiting of Y
coordinate, X coordinate, tile index, and attributes (1 byte each, in that
order). The X coordinates are offset by -8 pixels (i,e. an X coordinate of 8
places the first column of the object tile in the first screen column), and Y
coordinates are offset by -16 in a similar way. This allows positioning objects
partially on screen. The tile index is the index of the tile to use for the
object, always in the low tile bank.</p>
<p>The object attribute byte is made up of the following fields:</p>
<table>
<thead>
<tr>
<th>Bits (0=LSB)</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>0-3</td>
<td>Unused (given meaning on Gameboy Colour)</td>
</tr>
<tr>
<td>4</td>
<td>Palette selection (0 = Object Palette 0, 1 = Object Palette 1)</td>
</tr>
<tr>
<td>5</td>
<td>X Flip - object image is flipped horizontally</td>
</tr>
<tr>
<td>6</td>
<td>Y Flip - object image is flipped veritcally</td>
</tr>
<tr>
<td>7</td>
<td>Priority - (0 = object always on top of background &amp; window, 1 = object only on top of colour 0 pixels of window &amp; background)</td>
</tr>
</tbody>
</table>
<p>When in double height (8x16) object mode (selected in the LCD control register)
each object is made up of two adjacent tiles in the low tile bank. The
least-significant bit of the tile index is ignored, the first (even numbered)
tile makes up the top half of the object and the second (odd numbered) tile
makes up the bottom half. Note that Y Flip applies to the whole 8x16 pixel
object, not the two tiles individually.</p>
<p>Objects which overlap are drawn in priority order: first by smallest X
coordinate and then (for objects with the same X coordinate) by smallest address
in OAM. Only a maximum of 10 objects can be drawn on a single scanline; these
are the 10 object with the highest priority (i.e. the leftmost 10, with ties
broken by lowest OAM address).</p>
<p>Objects with a Y coordinate of 0 or &gt;= 160 will be ignored (as they are entirely
off-screen), however objects with an X coordinate of 0 will not be visible but
still count towards the object count of that scanline!</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="gpu_functions0" href="#gpu_functions0">gpu functions</a><span class="chunk-index"> (0 <a href="#gpu_functions1">1</a> <a href="#gpu_functions2">2</a>)</span> &gt;&gt=
&lt;&lt <a href="#video_helpers0">video helpers</a> &gt;&gt;
<span class="k">static</span> <span class="kt">void</span> <span class="nf">video_readSprites</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scanlineNum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* sprites can be 8x8 or 8x16 */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spriteHeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDControl</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span><span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>

    <span class="cm">/* Collect all the sprites on the current scanline */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numSprites</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">GameboySprite</span><span class="o">*</span> <span class="n">sprites</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">ScanlineSprites</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Position of top-left corner of sprite, offset by (8,16)</span>
<span class="cm">         * i.e. top left corner of display is (8,16)</span>
<span class="cm">         */</span>
        <span class="kt">uint8_t</span> <span class="n">ypos</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">OAM</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="kt">uint8_t</span> <span class="n">xpos</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">OAM</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ypos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ypos</span> <span class="o">&lt;</span> <span class="mi">160</span> <span class="o">&amp;&amp;</span> <span class="n">xpos</span> <span class="o">&lt;</span> <span class="mi">168</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* on screen */</span>
            <span class="k">if</span><span class="p">(</span><span class="n">scanlineNum</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&gt;=</span> <span class="n">ypos</span> <span class="o">&amp;&amp;</span> <span class="n">scanlineNum</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&lt;</span> <span class="n">ypos</span> <span class="o">+</span> <span class="n">spriteHeight</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* in scanline */</span>
                <span class="cm">/* Insert the sprite into the list, keeping the list in priority order */</span>
                <span class="n">assert</span><span class="p">(</span><span class="n">numSprites</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">);</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">insPos</span> <span class="o">=</span> <span class="n">numSprites</span><span class="p">;</span>
                <span class="k">while</span><span class="p">(</span><span class="n">insPos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sprites</span><span class="p">[</span><span class="n">insPos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">xpos</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">insPos</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">sprites</span><span class="p">[</span><span class="n">insPos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprites</span><span class="p">[</span><span class="n">insPos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                    <span class="p">}</span>
                    <span class="n">insPos</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">insPos</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">uint8_t</span> <span class="n">tile</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">OAM</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
                    <span class="kt">uint8_t</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">OAM</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">spriteHeight</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">tile</span> <span class="o">&amp;=</span> <span class="mh">0xFE</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="kt">unsigned</span> <span class="n">tileY</span> <span class="o">=</span> <span class="n">scanlineNum</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">ypos</span><span class="p">;</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Y Flip */</span>
                        <span class="n">tileY</span> <span class="o">=</span> <span class="p">(</span><span class="n">spriteHeight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">tileY</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="kt">uint16_t</span> <span class="n">tileAddr</span> <span class="o">=</span> <span class="n">video_tileLineAddress</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">tileY</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

                    <span class="n">sprites</span><span class="p">[</span><span class="n">insPos</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">xpos</span><span class="p">;</span>
                    <span class="n">sprites</span><span class="p">[</span><span class="n">insPos</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">[</span><span class="n">tileAddr</span><span class="p">];</span>
                    <span class="n">sprites</span><span class="p">[</span><span class="n">insPos</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">VideoRAM</span><span class="p">[</span><span class="n">tileAddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                    <span class="n">sprites</span><span class="p">[</span><span class="n">insPos</span><span class="p">].</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attr</span><span class="p">;</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">insPos</span> <span class="o">&gt;=</span> <span class="n">numSprites</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">numSprites</span> <span class="o">=</span> <span class="n">insPos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">NumSprites</span> <span class="o">=</span> <span class="n">numSprites</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<h2 id="pixel-rendering">Pixel rendering</h2>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="gpu_functions1" href="#gpu_functions0">gpu functions</a><span class="chunk-index"> (<a href="#gpu_functions0">0</a> 1 <a href="#gpu_functions2">2</a>)</span> &gt;&gt=
<span class="k">static</span> <span class="kt">void</span> <span class="nf">video_drawPixel</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scanlineNum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">lcdc</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDControl</span><span class="p">];</span>
    <span class="kt">bool</span> <span class="n">hiMapBG</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcdc</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">hiMapWin</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcdc</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">bgEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcdc</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">winEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcdc</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">spriteEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcdc</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">loTiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcdc</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>

    <span class="kt">uint8_t</span> <span class="n">wy</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_WindowY</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="n">wx</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_WindowX</span><span class="p">];</span>

    <span class="n">winEnable</span> <span class="o">=</span> <span class="n">winEnable</span> <span class="o">&amp;&amp;</span> <span class="n">wx</span> <span class="o">&lt;</span> <span class="mi">167</span> <span class="o">&amp;&amp;</span> <span class="n">wy</span> <span class="o">&lt;</span> <span class="mi">144</span> <span class="o">&amp;&amp;</span> <span class="n">wy</span> <span class="o">&lt;=</span> <span class="n">scanlineNum</span><span class="p">;</span>
    <span class="n">spriteEnable</span> <span class="o">=</span> <span class="n">spriteEnable</span> <span class="o">&amp;&amp;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">NumSprites</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">winEnable</span> <span class="o">||</span> <span class="n">bgEnable</span> <span class="o">||</span> <span class="n">spriteEnable</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint8_t</span> <span class="n">scy</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ScrollY</span><span class="p">];</span>
        <span class="kt">uint8_t</span> <span class="n">scx</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ScrollX</span><span class="p">];</span>

        <span class="kt">uint8_t</span> <span class="n">bgPixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">winEnable</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">&gt;=</span> <span class="n">wx</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bgPixel</span> <span class="o">=</span> <span class="n">video_mapPixel</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">hiMapWin</span><span class="p">,</span> <span class="n">loTiles</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">wx</span><span class="p">,</span> <span class="n">scanlineNum</span> <span class="o">-</span> <span class="n">wy</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">bgEnable</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bgPixel</span> <span class="o">=</span> <span class="n">video_mapPixel</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">hiMapBG</span><span class="p">,</span> <span class="n">loTiles</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">scx</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="n">scanlineNum</span> <span class="o">+</span> <span class="n">scy</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kt">uint8_t</span> <span class="n">finalColour</span> <span class="o">=</span> <span class="n">video_paletteLookup</span><span class="p">(</span><span class="n">bgPixel</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_BackgroundPalette</span><span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">spriteEnable</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">uint8_t</span> <span class="n">obp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ObjectPalette0</span><span class="p">],</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_ObjectPalette1</span><span class="p">]</span> <span class="p">};</span>
            <span class="k">struct</span> <span class="n">GameboySprite</span> <span class="k">const</span><span class="o">*</span> <span class="n">sprites</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">ScanlineSprites</span><span class="p">;</span>

            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">NumSprites</span><span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&gt;=</span> <span class="n">sprites</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">sprites</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">x</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tileX</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">sprites</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
                    <span class="kt">bool</span> <span class="k">const</span> <span class="n">mirrored</span> <span class="o">=</span> <span class="p">(</span><span class="n">sprites</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">attrs</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>
                    <span class="kt">uint8_t</span> <span class="n">pixel</span> <span class="o">=</span> <span class="n">video_linePixel</span><span class="p">(</span><span class="n">sprites</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">pixels</span><span class="p">,</span> <span class="n">mirrored</span><span class="o">?</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">tileX</span><span class="p">)</span> <span class="o">:</span> <span class="n">tileX</span><span class="p">);</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">bool</span> <span class="n">hasPriority</span> <span class="o">=</span> <span class="p">(</span><span class="n">sprites</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">attrs</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">finalColour</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hasPriority</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kt">uint8_t</span> <span class="n">palette</span> <span class="o">=</span> <span class="n">obp</span><span class="p">[(</span><span class="n">sprites</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">attrs</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">];</span>
                            <span class="n">finalColour</span> <span class="o">=</span> <span class="n">video_paletteLookup</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="n">palette</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="cm">/* Only draw first non-zero sprite pixel */</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">Buffer</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">scanlineNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalColour</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h2 id="video-update">Video update</h2>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="function_declarations3" href="#function_declarations0">function declarations</a><span class="chunk-index"> (<a href="#function_declarations0">0</a> <a href="#function_declarations1">1</a> <a href="#function_declarations2">2</a> 3 <a href="#function_declarations4">4</a>)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">video_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="per_machine_cycle_updates4" href="#per_machine_cycle_updates0">per machine cycle updates</a><span class="chunk-index"> (<a href="#per_machine_cycle_updates0">0</a> <a href="#per_machine_cycle_updates1">1</a> <a href="#per_machine_cycle_updates2">2</a> <a href="#per_machine_cycle_updates3">3</a> 4)</span> &gt;&gt=
<span class="cm">/* Video runs at 1 pixel per clock (4 per machine cycle) */</span>
<span class="n">video_update</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
<span class="n">video_update</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
<span class="n">video_update</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
<span class="n">video_update</span><span class="p">(</span><span class="n">gb</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="gpu_functions2" href="#gpu_functions0">gpu functions</a><span class="chunk-index"> (<a href="#gpu_functions0">0</a> <a href="#gpu_functions1">1</a> 2)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">video_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Each scanline takes 456 cycles to draw */</span>
    <span class="kt">uint8_t</span> <span class="n">scanline</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">FrameProgress</span> <span class="o">/</span> <span class="mi">456</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">scanline</span> <span class="o">&lt;=</span> <span class="mi">154</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">lcdOn</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDControl</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDY</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanline</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">];</span>

    <span class="cm">/* Handle LCDY compare - a bit in the STAT register is set and optionally an</span>
<span class="cm">     * interrupt is fired when the LCDY == LCDYCompare */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">lcdOn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">scanline</span> <span class="o">==</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDYCompare</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* Set coincidence bit */</span>
                <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
                <span class="cm">/* Fire interrupt if enabled */</span>
                <span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Interrupt_LCDC</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcdMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>

    <span class="cm">/* The last 10 scanlines are the VBlank - nothing is actually drawn */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">scanline</span> <span class="o">&gt;=</span> <span class="mi">144</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">lcdMode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* Entering VBlank - trigger interrupt */</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Interrupt_VBlank</span><span class="p">;</span>
            <span class="k">if</span><span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDControl</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">Buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">Buffer</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">NewFrame</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* During each scanline the LCD mode cycles through 3 states:</span>
<span class="cm">         * 92clks - mode 2 (reading OAM)</span>
<span class="cm">         * 160clks - mode 3 (reading OAM &amp; VRAM)</span>
<span class="cm">         * 204clks - mode 0 (HBlank)</span>
<span class="cm">         * = 456clks total</span>
<span class="cm">         */</span>
        <span class="kt">uint64_t</span> <span class="n">scanlineProgress</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">FrameProgress</span> <span class="o">%</span> <span class="mi">456</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">scanlineProgress</span> <span class="o">&lt;</span> <span class="mi">92</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">lcdMode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Entering mode 2 */</span>
                <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Interrupt_LCDC</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">video_readSprites</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">scanline</span><span class="p">);</span>
                <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">CurX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">scanlineProgress</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">160</span> <span class="o">+</span> <span class="mi">92</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">lcdOn</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span><span class="p">(;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">CurX</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">scanlineProgress</span> <span class="o">-</span> <span class="mi">92</span><span class="p">);</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">CurX</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">video_drawPixel</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">scanline</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">CurX</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">lcdMode</span><span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Entering mode 0 */</span>
                <span class="k">if</span><span class="p">(</span><span class="n">lcdOn</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for</span><span class="p">(;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">CurX</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">;</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">CurX</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">video_drawPixel</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">scanline</span><span class="p">,</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">CurX</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_LCDStat</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Interrupt_LCDC</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">FrameProgress</span> <span class="o">=</span> <span class="p">(</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">.</span><span class="n">FrameProgress</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">70224</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<h1 id="input">Input</h1>
<p>The eight buttons on the Gameboy each have a bit</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="buttons_enum0" href="#buttons_enum0">buttons enum</a> &gt;&gt=
<span class="k">enum</span> <span class="p">{</span>
    <span class="n">Button_Down</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
    <span class="n">Button_Up</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
    <span class="n">Button_Left</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
    <span class="n">Button_Right</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>

    <span class="n">Button_Start</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
    <span class="n">Button_Select</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
    <span class="n">Button_B</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
    <span class="n">Button_A</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="p">};</span>
</code></pre>

<p>A bitfield in the <code>Gameboy</code> structure contains which buttons are currently
pressed.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="state8" href="#state0">state</a><span class="chunk-index"> (<a href="#state0">0</a> <a href="#state1">1</a> <a href="#state2">2</a> <a href="#state3">3</a> <a href="#state4">4</a> <a href="#state5">5</a> <a href="#state6">6</a> <a href="#state7">7</a> 8)</span> &gt;&gt=
<span class="k">struct</span> <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Pressed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">buttons</span><span class="p">;</span>
</code></pre>

<p>This bitfield is updated by two functions:</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="function_declarations4" href="#function_declarations0">function declarations</a><span class="chunk-index"> (<a href="#function_declarations0">0</a> <a href="#function_declarations1">1</a> <a href="#function_declarations2">2</a> <a href="#function_declarations3">3</a> 4)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">input_setUp</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">button</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">input_setDown</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">button</span><span class="p">);</span>
</code></pre>

<p>The function to mark a button as pressed raises an interrupt.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_set_down0" href="#input_set_down0">input set down</a> &gt;&gt=
<span class="kt">void</span> <span class="nf">input_setDown</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">button</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">((</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">buttons</span><span class="p">.</span><span class="n">Pressed</span> <span class="o">&amp;</span> <span class="n">button</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">buttons</span><span class="p">.</span><span class="n">Pressed</span> <span class="o">|=</span> <span class="n">button</span><span class="p">;</span>
        <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_InterruptFlag</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Interrupt_Joypad</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>There is no interrupt when a button is released</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_set_up0" href="#input_set_up0">input set up</a> &gt;&gt=
<span class="kt">void</span> <span class="nf">input_setUp</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">button</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">buttons</span><span class="p">.</span><span class="n">Pressed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">button</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<p><a name="regff00"></a>
The joypad register at address <code>0xFF00</code> is used by the game to query which buttons are pressed.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_update_function0" href="#input_update_function0">input update function</a> &gt;&gt=
<span class="kt">void</span> <span class="nf">input_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">)</span>
<span class="p">{</span>
    &lt;&lt <a href="#input_update0">input update</a> &gt;&gt;
<span class="p">}</span>
</code></pre>

<p>The button bits provided to the software on the Gameboy are active-low</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_update0" href="#input_update0">input update</a><span class="chunk-index"> (0 <a href="#input_update1">1</a> <a href="#input_update2">2</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="n">invButtons</span> <span class="o">=</span> <span class="o">~</span><span class="n">gb</span><span class="o">-&gt;</span><span class="n">buttons</span><span class="p">.</span><span class="n">Pressed</span><span class="p">;</span>
</code></pre>

<p>The software running on the Gameboy can only check four of the eight buttons at
once. Bits 4 &amp; 5 in the joypad register determine which subset of buttons are
checked; bit 5 requests the directional buttons, bit 4 the others (A, B, Start,
Select).</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_update1" href="#input_update0">input update</a><span class="chunk-index"> (<a href="#input_update0">0</a> 1 <a href="#input_update2">2</a>)</span> &gt;&gt=
<span class="kt">uint8_t</span> <span class="n">joyReg</span> <span class="o">=</span> <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_Joypad</span><span class="p">];</span>
<span class="k">if</span><span class="p">((</span><span class="n">joyReg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Directional keys */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_Joypad</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">joyReg</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">invButtons</span> <span class="o">&gt;&gt;</span> <span class="mi">4u</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">joyReg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Buttons */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_Joypad</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">joyReg</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">invButtons</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">));</span>
<span class="p">}</span>
</code></pre>

<p>Additionally setting both bit 4 &amp; 5 allow detection of the type of Gameboy hardware.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_update2" href="#input_update0">input update</a><span class="chunk-index"> (<a href="#input_update0">0</a> <a href="#input_update1">1</a> 2)</span> &gt;&gt=
<span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">joyReg</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Model check - 0xFX == classic gameboy */</span>
    <span class="n">gb</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">IO</span><span class="p">[</span><span class="n">IO_Joypad</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_functions0" href="#input_functions0">input functions</a> &gt;&gt=
&lt;&lt <a href="#input_set_up0">input set up</a> &gt;&gt;
&lt;&lt <a href="#input_set_down0">input set down</a> &gt;&gt;
&lt;&lt <a href="#input_update_function0">input update function</a> &gt;&gt;
&lt;&lt <a href="#input_interface_function0">input interface function</a> &gt;&gt;
</code></pre>

<p>An external function is provided for users of the library to easily provide user input to the Gameboy. It just calls the internal <code>input_setUp</code> and <code>input_setDown</code> functions.</p>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="public_function_declarations4" href="#public_function_declarations0">public function declarations</a><span class="chunk-index"> (<a href="#public_function_declarations0">0</a> <a href="#public_function_declarations1">1</a> <a href="#public_function_declarations2">2</a> <a href="#public_function_declarations3">3</a> 4)</span> &gt;&gt=
<span class="kt">void</span> <span class="nf">gameboy_setButtonState</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">button</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">down</span><span class="p">);</span>
</code></pre>

<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="input_interface_function0" href="#input_interface_function0">input interface function</a> &gt;&gt=
<span class="kt">void</span> <span class="nf">gameboy_setButtonState</span><span class="p">(</span><span class="k">struct</span> <span class="n">Gameboy</span><span class="o">*</span> <span class="n">gb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">button</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">down</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">down</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">input_setDown</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">button</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">input_setUp</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">button</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<h1 id="io-register-index">IO Register Index</h1>
<ul>
<li><code>0xFF00</code> <a href="#regff00">Joypad</a></li>
<li><code>0xFF01</code> <a href="#regff01">Serial data</a></li>
<li><code>0xFF02</code> <a href="#regff02">Serial control</a></li>
<li><code>0xFF04</code> <a href="#regff04">Divider</a></li>
<li><code>0xFF05</code> <a href="#regff05">Timer</a></li>
<li><code>0xFF06</code> <a href="#regff06">Timer modulo</a></li>
<li><code>0xFF07</code> <a href="#regff07">Timer Control</a></li>
<li><code>0xFF0F</code> <a href="#regff0f">Interrupt Flag</a></li>
<li><code>0xFF40</code> <a href="#regff40">LCD control</a></li>
<li><code>0xFF41</code> <a href="#regff41">LCD Status</a></li>
<li><code>0xFF42</code> <a href="#regff42">LCD Scroll X</a></li>
<li><code>0xFF43</code> <a href="#regff43">LCD Scroll Y</a></li>
<li><code>0xFF44</code> <a href="#regff44">LCD Y</a></li>
<li><code>0xFF45</code> <a href="#regff45">LCD Y Compare</a></li>
<li><code>0xFF46</code> <a href="#regff46">OAM DMA Control</a></li>
<li><code>0xFF47</code> <a href="#regff47">Background palette</a></li>
<li><code>0xFF48</code> <a href="#regff48">Object palette 0</a></li>
<li><code>0xFF49</code> <a href="#regff49">Object palette 1</a></li>
<li><code>0xFF4A</code> <a href="#regff4a">LCD Window X</a></li>
<li><code>0xFF4B</code> <a href="#regff4b">LCD Window Y</a></li>
<li><code>0xFF50</code> <a href="#regff50">Boot ROM Enable</a></li>
<li><code>0xFFFF</code> <a href="#regffff">Interrupt enable</a></li>
</ul>
<h1 id="cpu-instruction-index">CPU instruction index</h1>
<ul>
<li>
<p><code>0x00</code> <a href="#op_00_nop">nop</a></p>
</li>
<li>
<p><a href="#op_ldrr">ld r, r</a></p>
</li>
<li><a href="#op_ldrm">ld r, ($hl)</a></li>
<li><a href="#op_ldmr">ld ($hl), r</a></li>
</ul>
<h1 id="gameboyc">gameboy.c</h1>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="gameboy.c0" href="#gameboy.c0">gameboy.c</a> &gt;&gt=
<span class="cm">/* Copyright (C) 2014-2018 Thomas Spurden &lt;thomas@spurden.name&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software: you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>
<span class="cp">#include</span> <span class="cpf">&quot;gameboy.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#ifndef NDEBUG</span>
<span class="cp">#define GBTRACE(gb, tp) do { if(gb-&gt;trace_fn) { gb-&gt;trace_fn(gb, tp); } } while(0)</span>
<span class="cp">#else</span>
<span class="cp">#define GBTRACE(gb, tp)</span>
<span class="cp">#endif</span>

&lt;&lt <a href="#io_register_addresses0">io register addresses</a> &gt;&gt;
&lt;&lt <a href="#io_registers_unused_bits0">io registers unused bits</a> &gt;&gt;
&lt;&lt <a href="#function_declarations0">function declarations</a> &gt;&gt;

&lt;&lt <a href="#clock_functions0">clock functions</a> &gt;&gt;
&lt;&lt <a href="#cpu_functions0">cpu functions</a> &gt;&gt;
&lt;&lt <a href="#memory_functions0">memory functions</a> &gt;&gt;
&lt;&lt <a href="#dma_update0">dma update</a> &gt;&gt;
&lt;&lt <a href="#gpu_functions0">gpu functions</a> &gt;&gt;
&lt;&lt <a href="#input_functions0">input functions</a> &gt;&gt;
&lt;&lt <a href="#gameboy_functions0">gameboy functions</a> &gt;&gt;
</code></pre>

<h1 id="gameboyh">gameboy.h</h1>
<pre class="codehilite"><code>&lt;&lt; <a class="code-chunk" id="gameboy.h0" href="#gameboy.h0">gameboy.h</a> &gt;&gt=
<span class="cp">#pragma once</span>
<span class="cm">/* Copyright (C) 2014-2018 Thomas Spurden &lt;thomas@spurden.name&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software: you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>

<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef NDEBUG</span>
<span class="k">struct</span> <span class="n">gameboy_tp</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="p">{</span>
        <span class="n">GAMEBOY_TP_MEM_READ</span><span class="p">,</span>
        <span class="n">GAMEBOY_TP_MEM_WRITE</span><span class="p">,</span>
        <span class="n">GAMEBOY_TP_INSTR_START</span><span class="p">,</span>
        <span class="n">GAMEBOY_TP_DMA_INIT</span><span class="p">,</span>
        <span class="n">GAMEBOY_TP_DMA_START</span><span class="p">,</span>
        <span class="n">GAMEBOY_TP_DMA</span><span class="p">,</span>
    <span class="p">}</span> <span class="n">point</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="p">{</span>
            <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">mem_read</span><span class="p">;</span>
        <span class="k">struct</span> <span class="p">{</span>
            <span class="kt">uint16_t</span> <span class="n">addr</span><span class="p">;</span>
            <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">mem_write</span><span class="p">;</span>
        <span class="k">struct</span> <span class="p">{</span>
            <span class="kt">uint8_t</span> <span class="n">opcode</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">instr_start</span><span class="p">;</span>
        <span class="k">struct</span> <span class="p">{</span>
            <span class="kt">uint16_t</span> <span class="n">src</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">dma</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

&lt;&lt <a href="#interrupt_bits_enum0">interrupt bits enum</a> &gt;&gt;
&lt;&lt <a href="#mmu_enum0">mmu enum</a> &gt;&gt;
&lt;&lt <a href="#buttons_enum0">buttons enum</a> &gt;&gt;

&lt;&lt <a href="#gameboy_state0">gameboy state</a> &gt;&gt;

&lt;&lt <a href="#public_function_declarations0">public function declarations</a> &gt;&gt;

<span class="cp">#ifdef __cplusplus</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</code></pre></body></html>
